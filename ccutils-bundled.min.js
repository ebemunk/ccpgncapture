"use strict";function similar_text(a,b,c){if(null===a||null===b||"undefined"==typeof a||"undefined"==typeof b)return 0;a+="",b+="";var d,e,f,g,h=0,i=0,j=0,k=a.length,l=b.length;for(j=0,d=0;k>d;d++)for(e=0;l>e;e++){for(f=0;k>d+f&&l>e+f&&a.charAt(d+f)===b.charAt(e+f);f++);f>j&&(j=f,h=d,i=e)}return g=j,g&&(h&&i&&(g+=similar_text(a.substr(0,h),b.substr(0,i))),k>h+j&&l>i+j&&(g+=similar_text(a.substr(h+j,k-h-j),b.substr(i+j,l-i-j)))),c?200*g/(k+l):g}var Chess=function(a){function b(){hb=new Array(128),ib={w:M,b:M},jb=L,kb={w:0,b:0},lb=M,mb=0,nb=1,ob=[],pb={},h(f())}function c(){d(U)}function d(a){var c=a.split(/\s+/),d=c[0],g=0;if(!e(a).valid)return!1;b();for(var i=0;i<d.length;i++){var k=d.charAt(i);if("/"===k)g+=8;else if(F(k))g+=parseInt(k,10);else{var l="a">k?L:K;j({type:k.toLowerCase(),color:l},D(g)),g++}}return jb=c[1],c[2].indexOf("K")>-1&&(kb.w|=ab.KSIDE_CASTLE),c[2].indexOf("Q")>-1&&(kb.w|=ab.QSIDE_CASTLE),c[2].indexOf("k")>-1&&(kb.b|=ab.KSIDE_CASTLE),c[2].indexOf("q")>-1&&(kb.b|=ab.QSIDE_CASTLE),lb="-"===c[3]?M:fb[c[3]],mb=parseInt(c[4],10),nb=parseInt(c[5],10),h(f()),!0}function e(a){var b={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."},c=a.split(/\s+/);if(6!==c.length)return{valid:!1,error_number:1,error:b[1]};if(isNaN(c[5])||parseInt(c[5],10)<=0)return{valid:!1,error_number:2,error:b[2]};if(isNaN(c[4])||parseInt(c[4],10)<0)return{valid:!1,error_number:3,error:b[3]};if(!/^(-|[abcdefgh][36])$/.test(c[3]))return{valid:!1,error_number:4,error:b[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(c[2]))return{valid:!1,error_number:5,error:b[5]};if(!/^(w|b)$/.test(c[1]))return{valid:!1,error_number:6,error:b[6]};var d=c[0].split("/");if(8!==d.length)return{valid:!1,error_number:7,error:b[7]};for(var e=0;e<d.length;e++){for(var f=0,g=!1,h=0;h<d[e].length;h++)if(isNaN(d[e][h])){if(!/^[prnbqkPRNBQK]$/.test(d[e][h]))return{valid:!1,error_number:9,error:b[9]};f+=1,g=!1}else{if(g)return{valid:!1,error_number:8,error:b[8]};f+=parseInt(d[e][h],10),g=!0}if(8!==f)return{valid:!1,error_number:10,error:b[10]}}return{valid:!0,error_number:0,error:b[0]}}function f(){for(var a=0,b="",c=fb.a8;c<=fb.h1;c++){if(null==hb[c])a++;else{a>0&&(b+=a,a=0);var d=hb[c].color,e=hb[c].type;b+=d===L?e.toUpperCase():e.toLowerCase()}c+1&136&&(a>0&&(b+=a),c!==fb.h1&&(b+="/"),a=0,c+=8)}var f="";kb[L]&ab.KSIDE_CASTLE&&(f+="K"),kb[L]&ab.QSIDE_CASTLE&&(f+="Q"),kb[K]&ab.KSIDE_CASTLE&&(f+="k"),kb[K]&ab.QSIDE_CASTLE&&(f+="q"),f=f||"-";var g=lb===M?"-":D(lb);return[b,jb,f,g,mb,nb].join(" ")}function g(a){for(var b=0;b<a.length;b+=2)"string"==typeof a[b]&&"string"==typeof a[b+1]&&(pb[a[b]]=a[b+1]);return pb}function h(a){ob.length>0||(a!==U?(pb.SetUp=a,pb.FEN="1"):(delete pb.SetUp,delete pb.FEN))}function i(a){var b=hb[fb[a]];return b?{type:b.type,color:b.color}:null}function j(a,b){if(!("type"in a&&"color"in a))return!1;if(-1===T.indexOf(a.type.toLowerCase()))return!1;if(!(b in fb))return!1;var c=fb[b];return hb[c]={type:a.type,color:a.color},a.type===S&&(ib[a.color]=c),h(f()),!0}function k(a){var b=i(a);return hb[fb[a]]=null,b&&b.type===S&&(ib[b.color]=M),h(f()),b}function l(a,b,c,d,e){var f={color:jb,from:b,to:c,flags:d,piece:a[b].type};return e&&(f.flags|=ab.PROMOTION,f.promotion=e),a[c]?f.captured=a[c].type:d&ab.EP_CAPTURE&&(f.captured=N),f}function m(a){function b(a,b,c,d,e){if(a[c].type!==N||B(d)!==eb&&B(d)!==bb)b.push(l(a,c,d,e));else for(var f=[R,Q,P,O],g=0,h=f.length;h>g;g++)b.push(l(a,c,d,e,f[g]))}var c=[],d=jb,e=E(d),f={b:db,w:cb},g=fb.a8,h=fb.h1,i=!1,j="undefined"!=typeof a&&"legal"in a?a.legal:!0;if("undefined"!=typeof a&&"square"in a){if(!(a.square in fb))return[];g=h=fb[a.square],i=!0}for(var k=g;h>=k;k++)if(136&k)k+=7;else{var m=hb[k];if(null!=m&&m.color===d)if(m.type===N){var n=k+W[d][0];if(null==hb[n]){b(hb,c,k,n,ab.NORMAL);var n=k+W[d][1];f[d]===B(k)&&null==hb[n]&&b(hb,c,k,n,ab.BIG_PAWN)}for(q=2;4>q;q++){var n=k+W[d][q];136&n||(null!=hb[n]&&hb[n].color===e?b(hb,c,k,n,ab.CAPTURE):n===lb&&b(hb,c,k,lb,ab.EP_CAPTURE))}}else for(var q=0,r=X[m.type].length;r>q;q++)for(var s=X[m.type][q],n=k;;){if(n+=s,136&n)break;if(null!=hb[n]){if(hb[n].color===d)break;b(hb,c,k,n,ab.CAPTURE);break}if(b(hb,c,k,n,ab.NORMAL),"n"===m.type||"k"===m.type)break}}if(!i||h===ib[d]){if(kb[d]&ab.KSIDE_CASTLE){var t=ib[d],u=t+2;null!=hb[t+1]||null!=hb[u]||o(e,ib[d])||o(e,t+1)||o(e,u)||b(hb,c,ib[d],u,ab.KSIDE_CASTLE)}if(kb[d]&ab.QSIDE_CASTLE){var t=ib[d],u=t-2;null!=hb[t-1]||null!=hb[t-2]||null!=hb[t-3]||o(e,ib[d])||o(e,t-1)||o(e,u)||b(hb,c,ib[d],u,ab.QSIDE_CASTLE)}}if(!j)return c;for(var v=[],k=0,r=c.length;r>k;k++)x(c[k]),p(d)||v.push(c[k]),y();return v}function n(a){var b="";if(a.flags&ab.KSIDE_CASTLE)b="O-O";else if(a.flags&ab.QSIDE_CASTLE)b="O-O-O";else{var c=z(a);a.piece!==N&&(b+=a.piece.toUpperCase()+c),a.flags&(ab.CAPTURE|ab.EP_CAPTURE)&&(a.piece===N&&(b+=D(a.from)[0]),b+="x"),b+=D(a.to),a.flags&ab.PROMOTION&&(b+="="+a.promotion.toUpperCase())}return x(a),q()&&(b+=r()?"#":"+"),y(),b}function o(a,b){for(var c=fb.a8;c<=fb.h1;c++)if(136&c)c+=7;else if(null!=hb[c]&&hb[c].color===a){var d=hb[c],e=c-b,f=e+119;if(Y[f]&1<<$[d.type]){if(d.type===N){if(e>0){if(d.color===L)return!0}else if(d.color===K)return!0;continue}if("n"===d.type||"k"===d.type)return!0;for(var g=Z[f],h=c+g,i=!1;h!==b;){if(null!=hb[h]){i=!0;break}h+=g}if(!i)return!0}}return!1}function p(a){return o(E(a),ib[a])}function q(){return p(jb)}function r(){return q()&&0===m().length}function s(){return!q()&&0===m().length}function t(){for(var a={},b=[],c=0,d=0,e=fb.a8;e<=fb.h1;e++)if(d=(d+1)%2,136&e)e+=7;else{var f=hb[e];f&&(a[f.type]=f.type in a?a[f.type]+1:1,f.type===P&&b.push(d),c++)}if(2===c)return!0;if(3===c&&(1===a[P]||1===a[O]))return!0;if(c===a[P]+2){for(var g=0,h=b.length,e=0;h>e;e++)g+=b[e];if(0===g||g===h)return!0}return!1}function u(){for(var a=[],b={},c=!1;;){var d=y();if(!d)break;a.push(d)}for(;;){var e=f().split(" ").slice(0,4).join(" ");if(b[e]=e in b?b[e]+1:1,b[e]>=3&&(c=!0),!a.length)break;x(a.pop())}return c}function v(){for(var a=[],b={},c=!1;;){var d=y();if(!d)break;a.push(d)}for(;;){var e=f().split(" ").slice(0,4).join(" ");if(b[e]=e in b?b[e]+1:1,b[e]>=2&&(c=!0),!a.length)break;x(a.pop())}return c}function w(a){ob.push({move:a,kings:{b:ib.b,w:ib.w},turn:jb,castling:{b:kb.b,w:kb.w},ep_square:lb,half_moves:mb,move_number:nb})}function x(a){var b=jb,c=E(b);if(w(a),hb[a.to]=hb[a.from],hb[a.from]=null,a.flags&ab.EP_CAPTURE&&(jb===K?hb[a.to-16]=null:hb[a.to+16]=null),a.flags&ab.PROMOTION&&(hb[a.to]={type:a.promotion,color:b}),hb[a.to].type===S){if(ib[hb[a.to].color]=a.to,a.flags&ab.KSIDE_CASTLE){var d=a.to-1,e=a.to+1;hb[d]=hb[e],hb[e]=null}else if(a.flags&ab.QSIDE_CASTLE){var d=a.to+1,e=a.to-2;hb[d]=hb[e],hb[e]=null}kb[b]=""}if(kb[b])for(var f=0,g=gb[b].length;g>f;f++)if(a.from===gb[b][f].square&&kb[b]&gb[b][f].flag){kb[b]^=gb[b][f].flag;break}if(kb[c])for(var f=0,g=gb[c].length;g>f;f++)if(a.to===gb[c][f].square&&kb[c]&gb[c][f].flag){kb[c]^=gb[c][f].flag;break}lb=a.flags&ab.BIG_PAWN?"b"===jb?a.to-16:a.to+16:M,a.piece===N?mb=0:a.flags&(ab.CAPTURE|ab.EP_CAPTURE)?mb=0:mb++,jb===K&&nb++,jb=E(jb)}function y(){var a=ob.pop();if(null==a)return null;var b=a.move;ib=a.kings,jb=a.turn,kb=a.castling,lb=a.ep_square,mb=a.half_moves,nb=a.move_number;var c=jb,d=E(jb);if(hb[b.from]=hb[b.to],hb[b.from].type=b.piece,hb[b.to]=null,b.flags&ab.CAPTURE)hb[b.to]={type:b.captured,color:d};else if(b.flags&ab.EP_CAPTURE){var e;e=c===K?b.to-16:b.to+16,hb[e]={type:N,color:d}}if(b.flags&(ab.KSIDE_CASTLE|ab.QSIDE_CASTLE)){var f,g;b.flags&ab.KSIDE_CASTLE?(f=b.to+1,g=b.to-1):b.flags&ab.QSIDE_CASTLE&&(f=b.to-2,g=b.to+1),hb[f]=hb[g],hb[g]=null}return b}function z(a){for(var b=m(),c=a.from,d=a.to,e=a.piece,f=0,g=0,h=0,i=0,j=b.length;j>i;i++){var k=b[i].from,l=b[i].to,n=b[i].piece;e===n&&c!==k&&d===l&&(f++,B(c)===B(k)&&g++,C(c)===C(k)&&h++)}return f>0?g>0&&h>0?D(c):h>0?D(c).charAt(1):D(c).charAt(0):""}function A(){for(var a="   +------------------------+\n",b=fb.a8;b<=fb.h1;b++){if(0===C(b)&&(a+=" "+"87654321"[B(b)]+" |"),null==hb[b])a+=" . ";else{var c=hb[b].type,d=hb[b].color,e=d===L?c.toUpperCase():c.toLowerCase();a+=" "+e+" "}b+1&136&&(a+="|\n",b+=8)}return a+="   +------------------------+\n",a+="     a  b  c  d  e  f  g  h\n"}function B(a){return a>>4}function C(a){return 15&a}function D(a){var b=C(a),c=B(a);return"abcdefgh".substring(b,b+1)+"87654321".substring(c,c+1)}function E(a){return a===L?K:L}function F(a){return-1!=="0123456789".indexOf(a)}function G(a){var b=H(a);b.san=n(b),b.to=D(b.to),b.from=D(b.from);var c="";for(var d in ab)ab[d]&b.flags&&(c+=_[d]);return b.flags=c,b}function H(a){var b=a instanceof Array?[]:{};for(var c in a)b[c]="object"==typeof c?H(a[c]):a[c];return b}function I(a){return a.replace(/^\s+|\s+$/g,"")}function J(a){for(var b=m({legal:!1}),c=0,d=jb,e=0,f=b.length;f>e;e++){if(x(b[e]),!p(d))if(a-1>0){var g=J(a-1);c+=g}else c++;y()}return c}var K="b",L="w",M=-1,N="p",O="n",P="b",Q="r",R="q",S="k",T="pnbrqkPNBRQK",U="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",V=["1-0","0-1","1/2-1/2","*"],W={b:[16,32,17,15],w:[-16,-32,-17,-15]},X={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Y=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Z=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],$={p:0,n:1,b:2,r:3,q:4,k:5},_={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},ab={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},bb=7,cb=6,db=1,eb=0,fb={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},gb={w:[{square:fb.a1,flag:ab.QSIDE_CASTLE},{square:fb.h1,flag:ab.KSIDE_CASTLE}],b:[{square:fb.a8,flag:ab.QSIDE_CASTLE},{square:fb.h8,flag:ab.KSIDE_CASTLE}]},hb=new Array(128),ib={w:M,b:M},jb=L,kb={w:0,b:0},lb=M,mb=0,nb=1,ob=[],pb={};return"undefined"==typeof a?d(U):d(a),{WHITE:L,BLACK:K,PAWN:N,KNIGHT:O,BISHOP:P,ROOK:Q,QUEEN:R,KING:S,SQUARES:function(){for(var a=[],b=fb.a8;b<=fb.h1;b++)136&b?b+=7:a.push(D(b));return a}(),FLAGS:_,load:function(a){return d(a)},reset:function(){return c()},moves:function(a){for(var b=m(a),c=[],d=0,e=b.length;e>d;d++)"undefined"!=typeof a&&"verbose"in a&&a.verbose?c.push(G(b[d])):c.push(n(b[d]));return c},in_check:function(){return q()},in_checkmate:function(){return r()},in_stalemate:function(){return s()},in_draw:function(){return mb>=100||s()||t()||u()},insufficient_material:function(){return t()},in_threefold_repetition:function(){return u()},in_twofold_repetition:function(){return v()},game_over:function(){return mb>=100||r()||s()||t()||u()},validate_fen:function(a){return e(a)},fen:function(){return f()},pgn:function(a){var b="object"==typeof a&&"string"==typeof a.newline_char?a.newline_char:"\n",c="object"==typeof a&&"number"==typeof a.max_width?a.max_width:0,d=[],e=!1;for(var f in pb)d.push("["+f+' "'+pb[f]+'"]'+b),e=!0;e&&ob.length&&d.push(b);for(var g=[];ob.length>0;)g.push(y());for(var h=[],i="",j=1;g.length>0;){var k=g.pop();1===j&&"b"===k.color?(i="1. ...",j++):"w"===k.color&&(i.length&&h.push(i),i=j+".",j++),i=i+" "+n(k),x(k)}if(i.length&&h.push(i),"undefined"!=typeof pb.Result&&h.push(pb.Result),0===c)return d.join("")+h.join(" ");for(var l=0,f=0;f<h.length;f++)l+h[f].length>c&&0!==f?(" "===d[d.length-1]&&d.pop(),d.push(b),l=0):0!==f&&(d.push(" "),l++),d.push(h[f]),l+=h[f].length;return d.join("")},load_pgn:function(a,b){function d(a){return a.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function e(a){var b,c,d,e=ab.NORMAL,f=a.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=?[NBRQ])?/);if("O-O-O"===a.slice(0,5))c=ib[jb],b=c-2,e=ab.QSIDE_CASTLE;else if("O-O"===a.slice(0,3))c=ib[jb],b=c+2,e=ab.KSIDE_CASTLE;else if(f&&f[1]){var g=f[1].toLowerCase();f[3]&&(e=ab.CAPTURE),b=fb[f[4]];for(var h=0,i=X[g].length;i>h;h++)for(var j=X[g][h],k=b;;){if(k+=j,136&k)break;var m=hb[k];if(m){m.color===jb&&m.type===g&&(!f[2]||D(k).indexOf(f[2])>=0)&&(c=k);break}if("n"===g||"k"===g)break}}else if(f){if(f[3]){b=fb[f[4]];for(var h=2;4>h;h++){var k=b-W[jb][h];136&k||null!=hb[k]&&hb[k].color===jb&&D(k)[0]===f[2]&&(c=k)}e=hb[b]?ab.CAPTURE:ab.EP_CAPTURE}else{b=fb[a.slice(0,2)];var n=b-W[jb][0],m=hb[n];m&&m.type===N&&m.color===jb?c=n:(n=b-W[jb][1],m=hb[n],m&&m.type===N&&m.color===jb&&(c=n,e=ab.BIG_PAWN))}f[5]&&(d="undefined"==typeof f[5][1]?f[5][0].toLowerCase():f[5][1].toLowerCase())}return c>=0&&b>=0&&e?l(hb,c,b,e,d):(a.length>0,void 0)}function f(a){return e(I(a))}function h(a){var b=!1;for(var c in a)b=!0;return b}function i(a,b){for(var c="object"==typeof b&&"string"==typeof b.newline_char?b.newline_char:"\r?\n",d={},e=a.split(c),f="",g="",h=0;h<e.length;h++)f=e[h].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),g=e[h].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),I(f).length>0&&(d[f]=g);return d}var j="object"==typeof b&&"string"==typeof b.newline_char?b.newline_char:"\r?\n",k=new RegExp("^(\\[(.|"+d(j)+")*\\])("+d(j)+")*1.("+d(j)+"|.)*$","g"),m=a.replace(k,"$1");"["!==m[0]&&(m=""),c();var n=i(m,b);for(var o in n)g([o,n[o]]);var p=a.replace(m,"").replace(new RegExp(d(j),"g")," ");p=p.replace(/(\{[^}]+\})+?/g,""),p=p.replace(/\d+\./g,"");var q=I(p).split(new RegExp(/\s+/));q=q.join(",").replace(/,,+/g,",").split(",");for(var r="",s=0;s<q.length-1;s++){if(r=f(q[s]),null==r)return!1;x(r)}if(r=q[q.length-1],V.indexOf(r)>-1)h(pb)&&"undefined"==typeof pb.Result&&g(["Result",r]);else{if(r=f(r),null==r)return!1;x(r)}return!0},header:function(){return g(arguments)},ascii:function(){return A()},turn:function(){return jb},move:function(a){var b=null,c=m();if("string"==typeof a){for(var d=0,e=c.length;e>d;d++)if(a===n(c[d])){b=c[d];break}}else if("object"==typeof a)for(var d=0,e=c.length;e>d;d++)if(!(a.from!==D(c[d].from)||a.to!==D(c[d].to)||"promotion"in c[d]&&a.promotion!==c[d].promotion)){b=c[d];break}if(!b)return null;var f=G(b);return x(b),f},undo:function(){var a=y();return a?G(a):null},clear:function(){return b()},put:function(a,b){return j(a,b)},get:function(a){return i(a)},remove:function(a){return k(a)},perft:function(a){return J(a)},square_color:function(a){if(a in fb){var b=fb[a];return(B(b)+C(b))%2===0?"light":"dark"}return null},history:function(a){for(var b=[],c=[],d=("undefined"!=typeof a&&"verbose"in a&&a.verbose);ob.length>0;)b.push(y());for(;b.length>0;){var e=b.pop();d?c.push(G(e)):c.push(n(e)),x(e)}return c}}};"undefined"!=typeof exports&&(exports.Chess=Chess),function(a,b){function c(b){var c,d=a(b.ownerDocument);return b=a(b),c=b.offset(),{x:c.left+b.outerWidth()/2-d.scrollLeft(),y:c.top+b.outerHeight()/2-d.scrollTop()}}var d=/^key/,e=/^(?:mouse|contextmenu)|click/;a.fn.simulate=function(b,c){return this.each(function(){new a.simulate(this,b,c)})},a.simulate=function(b,c,d){var e=a.camelCase("simulate-"+c);this.target=b,this.options=d,this[e]?this[e]():this.simulateEvent(b,c,d)},a.extend(a.simulate,{keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},buttonCode:{LEFT:0,MIDDLE:1,RIGHT:2}}),a.extend(a.simulate.prototype,{simulateEvent:function(a,b,c){var d=this.createEvent(b,c);this.dispatchEvent(a,b,d,c)},createEvent:function(a,b){return d.test(a)?this.keyEvent(a,b):e.test(a)?this.mouseEvent(a,b):void 0},mouseEvent:function(c,d){var e,f,g,h;return d=a.extend({bubbles:!0,cancelable:"mousemove"!==c,view:window,detail:0,screenX:0,screenY:0,clientX:1,clientY:1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:b},d),document.createEvent?(e=document.createEvent("MouseEvents"),e.initMouseEvent(c,d.bubbles,d.cancelable,d.view,d.detail,d.screenX,d.screenY,d.clientX,d.clientY,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.button,d.relatedTarget||document.body.parentNode),0===e.pageX&&0===e.pageY&&Object.defineProperty&&(f=e.relatedTarget.ownerDocument||document,g=f.documentElement,h=f.body,Object.defineProperty(e,"pageX",{get:function(){return d.clientX+(g&&g.scrollLeft||h&&h.scrollLeft||0)-(g&&g.clientLeft||h&&h.clientLeft||0)}}),Object.defineProperty(e,"pageY",{get:function(){return d.clientY+(g&&g.scrollTop||h&&h.scrollTop||0)-(g&&g.clientTop||h&&h.clientTop||0)}}))):document.createEventObject&&(e=document.createEventObject(),a.extend(e,d),e.button={0:1,1:4,2:2}[e.button]||e.button),e},keyEvent:function(c,d){var e;if(d=a.extend({bubbles:!0,cancelable:!0,view:window,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:0,charCode:b},d),document.createEvent)try{e=document.createEvent("KeyEvents"),e.initKeyEvent(c,d.bubbles,d.cancelable,d.view,d.ctrlKey,d.altKey,d.shiftKey,d.metaKey,d.keyCode,d.charCode)}catch(f){e=document.createEvent("Events"),e.initEvent(c,d.bubbles,d.cancelable),a.extend(e,{view:d.view,ctrlKey:d.ctrlKey,altKey:d.altKey,shiftKey:d.shiftKey,metaKey:d.metaKey,keyCode:d.keyCode,charCode:d.charCode})}else document.createEventObject&&(e=document.createEventObject(),a.extend(e,d));return(/msie [\w.]+/.exec(navigator.userAgent.toLowerCase())||"[object Opera]"==={}.toString.call(window.opera))&&(e.keyCode=d.charCode>0?d.charCode:d.keyCode,e.charCode=b),e},dispatchEvent:function(a,b,c){a.dispatchEvent?a.dispatchEvent(c):a.fireEvent&&a.fireEvent("on"+b,c)},simulateFocus:function(){function b(){d=!0}var c,d=!1,e=a(this.target);e.bind("focus",b),e[0].focus(),d||(c=a.Event("focusin"),c.preventDefault(),e.trigger(c),e.triggerHandler("focus")),e.unbind("focus",b)},simulateBlur:function(){function b(){d=!0}var c,d=!1,e=a(this.target);e.bind("blur",b),e[0].blur(),setTimeout(function(){e[0].ownerDocument.activeElement===e[0]&&e[0].ownerDocument.body.focus(),d||(c=a.Event("focusout"),c.preventDefault(),e.trigger(c),e.triggerHandler("blur")),e.unbind("blur",b)},1)}}),a.extend(a.simulate.prototype,{simulateDrag:function(){var a=0,b=this.target,d=this.options,e=c(b),f=Math.floor(e.x),g=Math.floor(e.y),h=d.dx||0,i=d.dy||0,j=d.moves||3,k={clientX:f,clientY:g};for(this.simulateEvent(b,"mousedown",k);j>a;a++)f+=h/j,g+=i/j,k={clientX:Math.round(f),clientY:Math.round(g)},this.simulateEvent(document,"mousemove",k);this.simulateEvent(b,"mouseup",k),this.simulateEvent(b,"click",k)}})}(jQuery),function(a,b){function c(a,b,c){return a.addEventListener?(a.addEventListener(b,c,!1),void 0):(a.attachEvent("on"+b,c),void 0)}function d(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return w[a.which]?w[a.which]:x[a.which]?x[a.which]:String.fromCharCode(a.which).toLowerCase()}function e(a,b){return a.sort().join(",")===b.sort().join(",")}function f(a){a=a||{};var b,c=!1;for(b in C)a[b]?c=!0:C[b]=0;c||(F=!1)}function g(a,b,c,d,f,g){var h,i,j=[],k=c.type;if(!A[a])return[];for("keyup"==k&&l(a)&&(b=[a]),h=0;h<A[a].length;++h)if(i=A[a][h],(d||!i.seq||C[i.seq]==i.level)&&k==i.action&&("keypress"==k&&!c.metaKey&&!c.ctrlKey||e(b,i.modifiers))){var m=!d&&i.combo==f,n=d&&i.seq==d&&i.level==g;(m||n)&&A[a].splice(h,1),j.push(i)}return j}function h(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function i(a,b,c,d){H.stopCallback(b,b.target||b.srcElement,c,d)||a(b,c)===!1&&(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),b.returnValue=!1,b.cancelBubble=!0)}function j(a,b,c){var d,e=g(a,b,c),h={},j=0,k=!1;for(d=0;d<e.length;++d)e[d].seq&&(j=Math.max(j,e[d].level));for(d=0;d<e.length;++d)if(e[d].seq){if(e[d].level!=j)continue;k=!0,h[e[d].seq]=1,i(e[d].callback,c,e[d].combo,e[d].seq)}else k||i(e[d].callback,c,e[d].combo);var m="keypress"==c.type&&E;c.type!=F||l(a)||m||f(h),E=k&&"keydown"==c.type}function k(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=d(a);if(b)return"keyup"==a.type&&D===b?(D=!1,void 0):(H.handleKey(b,h(a),a),void 0)}function l(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function m(){clearTimeout(v),v=setTimeout(f,1e3)}function n(){if(!u){u={};for(var a in w)a>95&&112>a||w.hasOwnProperty(a)&&(u[w[a]]=a)}return u}function o(a,b,c){return c||(c=n()[a]?"keydown":"keypress"),"keypress"==c&&b.length&&(c="keydown"),c}function p(a,b,c,e){function g(b){return function(){F=b,++C[a],m()}}function h(b){i(c,b,a),"keyup"!==e&&(D=d(b)),setTimeout(f,10)}C[a]=0;for(var j=0;j<b.length;++j){var k=j+1===b.length,l=k?h:g(e||r(b[j+1]).action);s(b[j],l,e,a,j)}}function q(a){return"+"===a?["+"]:a.split("+")}function r(a,b){var c,d,e,f=[];for(c=q(a),e=0;e<c.length;++e)d=c[e],z[d]&&(d=z[d]),b&&"keypress"!=b&&y[d]&&(d=y[d],f.push("shift")),l(d)&&f.push(d);return b=o(d,f,b),{key:d,modifiers:f,action:b}}function s(a,b,c,d,e){B[a+":"+c]=b,a=a.replace(/\s+/g," ");var f,h=a.split(" ");return h.length>1?(p(a,h,b,c),void 0):(f=r(a,c),A[f.key]=A[f.key]||[],g(f.key,f.modifiers,{type:f.action},d,a,e),A[f.key][d?"unshift":"push"]({callback:b,modifiers:f.modifiers,action:f.action,seq:d,level:e,combo:a}),void 0)}function t(a,b,c){for(var d=0;d<a.length;++d)s(a[d],b,c)}for(var u,v,w={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},x={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},y={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},z={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},A={},B={},C={},D=!1,E=!1,F=!1,G=1;20>G;++G)w[111+G]="f"+G;for(G=0;9>=G;++G)w[G+96]=G;c(b,"keypress",k),c(b,"keydown",k),c(b,"keyup",k);var H={bind:function(a,b,c){return a=a instanceof Array?a:[a],t(a,b,c),this},unbind:function(a,b){return H.bind(a,function(){},b)},trigger:function(a,b){return B[a+":"+b]&&B[a+":"+b]({},a),this},reset:function(){return A={},B={},this},stopCallback:function(a,b){return(" "+b.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},handleKey:j};a.Mousetrap=H,"function"==typeof define&&define.amd&&define(H)}(window,document),function(){$.extend(CC,{classify_opening:function(a){var b,c,d=new Chess,e="";return $.each(a,function(a,f){0===a?e+="1.":a%2===0&&(e+=a/2+1+"."),e+=f+" ",d.move(f);var g=CC.openings[e.trim()];g&&(b=g);var h=CC.openings[CC.openings_fen[d.fen()]];h&&(c=h)}),{moves:b,fen:c}},get_opening:function(a){var b=$('div[id^="notation_"]:visible');if(!b.length)return $("#ccutils_opening_moves").text("Notation window not visible."),$("#ccutils_opening_fen").text(""),void 0;if(b.length>1)return $("#ccutils_opening_moves").text("Cannot run when games popped-out."),$("#ccutils_opening_fen").text(":("),void 0;var c=window.location.hash.replace(/#(g|a)=/,"");if(CC.analyzed_games_cache[c]&&CC.analyzed_games_cache[c].count>4&&"N/A"!=CC.analyzed_games_cache[c].opening&&CC.analyzed_games_cache[c].num_moves>16&&!a)return $("#ccutils_opening_moves").text(CC.analyzed_games_cache[c].opening),$("#ccutils_opening_fen").text(CC.analyzed_games_cache[c].fen),void 0;var d,e=[];d=b.find(".notationVertical"),d.length?d.each(function(a,b){$(b).find(".gotomove").each(function(a,b){e.push($(b).text())})}):(d=b.find(".notationHorizontal"),d.length&&d.each(function(a,b){$(b).find(".gotomove").each(function(a,b){var c=$(b).text().match(/\d*\.\s*(.*)/);c?e.push(c[1]):e.push($(b).text())})}));var f,g,h=CC.classify_opening(e);f=h.moves?"Opening: "+h.moves.eco+":  "+h.moves.name+" ("+h.moves.moves+")":"N/A",g=h.fen?"Position: "+h.fen.eco+":  "+h.fen.name+" ("+h.fen.moves+")":"N/A";var i=1;return CC.analyzed_games_cache[c]&&CC.analyzed_games_cache[c].opening==f&&CC.analyzed_games_cache[c].fen==g&&(i=CC.analyzed_games_cache[c].count+1),CC.analyzed_games_cache[c]={opening:f,fen:g,count:i,num_moves:e.length},$("#ccutils_opening_moves").text()!=f&&$("#ccutils_opening_moves").text(f),$("#ccutils_opening_fen").text()!=g&&$("#ccutils_opening_fen").text(g),h},opening_refresh:function(){CC.game_all_channel=$.cometd.addListener("/game/*",function(a){CC.get_opening(a)})},flash_keyboard_icon:function(){$("#ccutils_keyboard_icon").animate({opacity:1},100).animate({opacity:.3},100)},announce_opening:function(){var a=CC.get_opening(!0);if(a){var b;b=a.moves.eco==a.fen.eco?"Opening: ("+a.moves.eco+") "+a.moves.name+" ("+(a.moves.moves.match(/\s/g).length+1)+"-ply)":similar_text(a.moves.name,a.fen.name,!0)>50?"Position: ("+a.fen.eco+") "+a.fen.name+" ("+(a.fen.moves.match(/\s/g).length+1)+"-ply)":"Position: ("+a.fen.eco+") "+a.fen.name+" ("+(a.fen.moves.match(/\s/g).length+1)+"-ply), transposed from Opening: ("+a.moves.eco+") "+a.moves.name,$(".chatInputGameWrapper input[id^=chatInput_]:visible").first().val(b),$(".chatInputGameWrapper button[id^=chatInputButton_]").click(),CC.flash_keyboard_icon(),CC.last_chat=Math.round((new Date).getTime()/1e3)+5}}}),CC.opening_checker=setInterval(CC.get_opening,5e3),CC.analyzed_games_cache={},setInterval(function(){CC.analyzed_games_cache={}},3e5),CC.opening_refresh();var a=$("<div/>").attr("id","ccutils_wrapper").css({position:"fixed",top:35,"z-index":9,color:"white",height:"28px",width:"100%"}).appendTo(body),b=$("<div/>").attr("id","ccutils_opening").css({"background-color":"#6a943f",margin:"0px 5px",height:"100%","border-radius":"5px 5px 0px 0px","border-top":"1px solid #799e52","border-bottom":"1px solid #4c7637","padding-left":"5px"}).appendTo(a).click(CC.get_opening),c=($("<p/>").attr({id:"ccutils_opening_moves",title:"Opening classification according to the move order."}).css({"font-size":"12px","line-height":"14px"}).appendTo(b),$("<p/>").attr({id:"ccutils_opening_fen",title:"Opening classification according to the game position."}).css({"font-size":"12px","line-height":"14px"}).appendTo(b),$("<div/>").attr("id","ccutils_keyboard_icon").css({"background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACEUlEQVRYhe3WMUhVURgH8N8xEZGIBgmRiKjFJFpqiIoWy6GhNVocm4qWkJpEJGoLXJormhtU2iKCBhscKiJaopJKCbEQCTFPw/2eXV/vYQ96vOV9l8O9/+/7zjn/+53/PeemLGuldbR09jaBNoE2AXRWHpJ0CuM40MT51nAPk1legVTZiJL0GMN400QCe9CDoSy/oFQB7MUKTuJnkwhMYBS7K45aGliP1oGNLK+V8HpgkOW1wOXcjarc6tgWqyfCM/iCa4EvYwHnk9SLKcwmqTdJxyM2kaQO3Im+A5G7gIf1StJZx7+MOXwO/DXwkkJI77AYlVmJ2IfIfR94NcbfhZ31CMhx4RW+oydwR6WVcrbFVbF+ZMyE71bg4UpezQokaRBXSngmy9MYwaEk3cUP3MAnTCbpNC4k6UFU4DoO1n3zsHpLsB+X/NHIEqZxVqGPRwpBjeA1JnEk+syG7yIGov96owSeVLFfjvtVdCvWfwNHS4PfD5LfFOs/hK6IrTZKoBt9mM/yfJL6knSiFN9XTk5SeffsD3IvFYI9pqjgYs2ZaokQ5xRiGY/YaOBG2mHFzpcx1ZAIFZ/ZGJ4GfhZ4O9uBX1GBRcUnOoa39TrUItCFj7gNSepSqHruHwjUsvI4f81XdsxjEM/V2DL/k/UpqlIR9RYCNxVv38zjeElxHG+euJvHcaus5X9EbQJtAm0CvwEi8Mhr8HnPPAAAAABJRU5ErkJggg==')",position:"fixed",top:34,right:10,"z-index":9,height:32,width:32,opacity:.3}).attr("title",' Key Bindings:\n   "shift+c s" Seek Game\n   "shift+c d" Offer Draw\n   "shift+c r" Resign\n   "shift+c shift+r" Clean Refresh\n   "shift+c shift+a" Announce Opening').appendTo(body),setInterval(function(){Mousetrap&&(clearInterval(c),Mousetrap.bind("shift+c s",function(){CC.flash_keyboard_icon(),$("#new_game_pane_create_button").click()}),Mousetrap.bind("shift+c d",function(){$("input[id^=b-draw]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-draw]:visible").click())}),Mousetrap.bind("shift+c r",function(){$("input[id^=b-resign-abort]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-resign-abort]:visible").click())}),Mousetrap.bind("shift+c shift+r",function(){CC.flash_keyboard_icon(),$(".nowrapTabStrip .dijitTabCloseButton").click(),setTimeout(function(){window.location="http://live.chess.com/live"},350)}),Mousetrap.bind("shift+c shift+a",function(){CC.announce_opening()}))},300))}(),function(){$.extend(CC,{decode:{a:"a1",i:"a2",q:"a3",y:"a4",G:"a5",O:"a6",W:"a7",4:"a8",b:"b1",j:"b2",r:"b3",z:"b4",H:"b5",P:"b6",X:"b7",5:"b8",c:"c1",k:"c2",s:"c3",A:"c4",I:"c5",Q:"c6",Y:"c7",6:"c8",d:"d1",l:"d2",t:"d3",B:"d4",J:"d5",R:"d6",Z:"d7",7:"d8",e:"e1",m:"e2",u:"e3",C:"e4",K:"e5",S:"e6",0:"e7",8:"e8",f:"f1",n:"f2",v:"f3",D:"f4",L:"f5",T:"f6",1:"f7",9:"f8",g:"g1",o:"g2",w:"g3",E:"g4",M:"g5",U:"g6",2:"g7","!":"g8",h:"h1",p:"h2",x:"h3",F:"h4",N:"h5",V:"h6",3:"h7","?":"h8"},promotions:{"{":[-1,"q"],"~":[0,"q"],"}":[1,"q"],"(":[-1,"n"],"^":[0,"n"],")":[1,"n"],"[":[-1,"r"],_:[0,"r"],"]":[1,"r"],"@":[-1,"b"],"#":[0,"b"],$:[1,"b"]},decode_moves:function(a){for(var b=new Chess,c=!0,d=0;d<a.length-1;d+=2){var e=a[d];e=CC.decode[e];var f=a[d+1],g="",h=c?1:-1;if(f in CC.promotions){g=CC.promotions[f][1];var i=String.fromCharCode(e.charCodeAt(0)+CC.promotions[f][0]),j=String.fromCharCode(e.charCodeAt(1)+h);f=i+j}else f=CC.decode[f];b.move({from:e,to:f,promotion:g}),c=!c}return b},listen:function(a,b){if("finished"==a.data.game.status){var c,d=CC.decode_moves(a.data.game.moves),e=CC.classify_opening(d.history()),f=new Date,g=f.getMonth()+1,h=f.getDate(),i=f.getFullYear()+"."+((""+g).length<2?"0":"")+g+"."+((""+h).length<2?"0":"")+h,j=!1,k=!1;"win"==a.data.game.results[0]?(c="1-0",k=0,j=1):"win"==a.data.game.results[1]?(c="0-1",k=1,j=0):c="1/2-1/2";var l;switch(a.data.game.results[j]){case"resigned":l=a.data.game.players[k].uid+" won by resignation.";break;case"timeout":l=a.data.game.players[k].uid+" won on time.";break;case"checkmated":l=a.data.game.players[k].uid+" won by checkmate.";break;case"abandoned":l=a.data.game.players[k].uid+" won - game abandoned.";break;case"agreed":l="Game drawn by agreement.";break;case"stalemate":l="Game drawn by stalemate.";break;case"repetition":l="Game drawn by repetition.";break;case"insufficient":l="Game drawn - insufficient material."}d.header("Event","Live Chess","Site","Chess.com","Date",i,"White",a.data.game.players[0].uid,"Black",a.data.game.players[1].uid,"Result",c,"WhiteElo",a.data.ratings[0],"BlackElo",a.data.ratings[1],"Termination",l,"ECO",e.moves.eco,"Opening",e.moves.name,"Position",e.fen.eco+": "+e.fen.name),$.ajax({url:"http://localhost/chesscomutils/write.php",type:"post",data:{pgn:d.pgn(),filename:b}}),console.log("WRITER REQUEST",b)}},toggle_pgn_capture:function(){$("#ccutils_capture").hasClass("saving")?($("#ccutils_capture").html("Capture PGN: Off").removeClass("saving").css("color","white"),$.cometd.unsubscribe(CC.service_game_channel)):($("#ccutils_capture").html("Capture PGN: On").addClass("saving").css("color","green"),CC.service_game_channel=$.cometd.subscribe("/service/game",CC.listen))
}});var a=$("<a/>").html("Capture PGN: Off").attr({href:"#",id:"ccutils_capture",title:"Capture all finished games in the PGN file."}).addClass("bold").click(CC.toggle_pgn_capture);$("#top_bar_settings").append($("<li/>").append(a)),$("#ccutils_capture").click()}(),function(){function a(a,b,c){this.myname=b,this.kibitz=!1,this.my_turn=void 0,this.im_white=void 0,this.depth=c,this.clocks=[void 0,void 0],this.o_delta=void 0,this.seq=0,this.persona=a,this.play_time_multiplier=1,this.play_times={opening:[7,3],panick:[4,3],scramble:[.3,.2]},this.recent_capture=!1,this.godmode=!1,this.last_opponent_name=!1,this.rematch_counter=0,this.score=0,this.bestmove=!1,this.game=null,this.enable=function(){this.game_channel=cometd.addListener("/game/*",$.proxy(this.game_packet_handler,this)),this.end_channel=cometd.subscribe("/service/game",$.proxy(this.end_packet_handler,this))},this.disable=function(){cometd.removeListener(this.game_channel),cometd.unsubscribe(this.end_channel)},this.update_info=function(a){var b="<table><tr><td>My Name: "+a.myname+"</td><td>Im White: "+a.im_white+"</td></tr><tr><td>Last Opp. Name: "+a.last_opponent_name+"</td><td>Rematch Counter: "+a.rematch_counter+"</td><td>Score: "+a.score+"</td></tr><tr><td>Clocks: "+a.clocks[0]+" | "+a.clocks[1]+"</td><td>Seq: "+a.seq+"</td><td>O_Delta: "+a.o_delta+"</td></tr></table><div>Best Move:"+a.bestmove+"</div><div>Forced Mate:"+a.forced_mate+"</div>";$("#bot_info").html(b)},this.end_packet_handler=function(a){if("EndGame"==a.data.tid){var b="game.aborted_by_server"==a.data.codemessage;if(!this.kibitz&&!b){window.CC.listen(a,this.myname+".pgn"),console.log("BOT: endgame pgn save routine ran");var c=a.data.game.players[this.im_white+0].uid;c==this.last_opponent_name?this.rematch_counter++:(this.rematch_counter=0,this.last_opponent_name=c)}$("#bot_reseek").is(":checked")||this.kibitz||(this.rematch_counter<2+2*Math.random()&&window.setTimeout(function(){$("button[id^=b-rematch]:visible").trigger("click")},1e3),window.setTimeout(function(){$("#new_game_pane_create_button").trigger("click")},5500)),this.game=new Chess,this.update_info(this)}},this.game_packet_handler=function(a){if("/game/~1"!=a.channel){if("FullGame"==a.data.tid&&(this.im_white=a.data.game.players[0].uid!=this.myname?!1:!0,this.clocks=a.data.game.clocks,this.game=new Chess),"GameState"==a.data.tid){this.im_white=a.data.game.players[0].uid!=this.myname?!1:!0,this.seq=a.data.game.seq;var b=this.im_white+0;this.kibitz?(this.im_white=!0,this.think(this.get_current_fen())):this.seq%2==0&&!this.im_white||this.seq%2==1&&this.im_white?this.opponents_turn_next():(this.o_delta=this.clocks[b]-a.data.game.clocks[b],this.my_turn_next()),this.clocks=a.data.game.clocks}this.update_info(this)}},this.get_current_fen=function(){var a=$('div[id^="notation_"]:visible');if(0==this.seq)return"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var b,c=[];b=a.find(".notationVertical"),b.each(function(a,b){$(b).find(".gotomove").each(function(a,b){c.push($(b).text())})});var d=new Chess;$.each(c,function(a,b){d.move(b)});var e=d.history({verbose:!0});return this.recent_capture=e[e.length-1].captured?!0:!1,this.game=d,d.fen()},this.my_turn_next=function(){this.think(this.get_current_fen())},this.opponents_turn_next=function(){},this.think=function(a){$.ajax({url:"http://localhost/chesscomutils/darkside/darkside.php",data:{fen:a,persona:this.persona,wtime:this.clocks[0],btime:this.clocks[1],depth:this.depth},crossDomain:!0,dataType:"jsonp",success:$.proxy(this.thought,this),error:function(){}})},this.thought=function(a){if(!this.kibitz){if("1"==a.forced_mate){if(a.score<0)return $("input[id^=b-resign-abort]:visible").trigger("click"),void 0}else if(a.score<-600)return $("input[id^=b-resign-abort]:visible").trigger("click"),void 0;this.move(a)}this.forced_mate="1"==a.forced_mate,this.score=a.score,this.bestmove=a.bestmove,this.seq%2==0,this.update_info(this)},this.move=function(a){var b=parseInt($("div[id^=letter_chessboard][id$=1]").not(".chessboard_dummy_piece").css("width")),c=a.bestmove.split(""),d=[c[0],c[1]],e=[c[2],c[3]],f=$("img[id^=img_chessboard][id$="+a.bestmove.substr(0,2)+"]:visible").not(".chessboard_dummy_piece"),g={a:1,b:2,c:3,d:4,e:5,f:6,g:7,h:8},h=g[e[0]]-g[d[0]],i=e[1]-d[1],j=(f.offset(),{top:-i*b,left:h*b});this.im_white||(j.top=-j.top,j.left=-j.left);var k=this.get_play_time();window.setTimeout(function(){f.simulate("drag",{dx:j.left,dy:j.top})},k)},this.get_play_time=function(){return this.godmode?0:this.seq<16&&Math.random()<.5?100*this.rnd(this.play_times.opening[0],this.play_times.opening[1]):this.recent_capture?100*this.rnd(this.play_times.opening[0],this.play_times.opening[1]):this.clocks[!this.im_white+0]<70?100*this.rnd(this.play_times.scramble[0],this.play_times.scramble[1]):this.clocks[!this.im_white+0]<150?100*this.rnd(this.play_times.panick[0],this.play_times.panick[1]):100*this.rnd(this.o_delta,2)},this.rnd_snd=function(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)},this.rnd=function(a,b){return Math.round(this.rnd_snd()*b+a)}}$("#bot_controls").remove();var b=$("<div/>").attr("id","bot_controls").css({position:"fixed",bottom:0,"z-index":9,color:"white",height:"200px",width:"50%",background:"rgba(0,0,0,0.3)",overflow:"scroll","padding-left":"15px"}).appendTo(body);window.mybot=new a("houdini","abii_91",3),b.load("http://localhost/chesscomutils/darkside/bot_controls.php"),b.on("click","#bot_enable",$.proxy(mybot.enable,mybot)),b.on("click","#bot_disable",$.proxy(mybot.disable,mybot)),b.on("change","#bot_char",function(){mybot.depth=$(this).val(),mybot.myname=$("#bot_char option:selected").text(),$("#bot_depth").val(mybot.depth)}),b.on("change","#bot_depth",function(){mybot.depth=$(this).val()}),b.on("change","#bot_kibitz",function(){mybot.kibitz=$(this).is(":checked")}),$("#dialog_basics_limited").remove(),$("#ad_content").remove()}();