"use strict";var Chess=function(fen){var BLACK="b";var WHITE="w";var EMPTY=-1;var PAWN="p";var KNIGHT="n";var BISHOP="b";var ROOK="r";var QUEEN="q";var KING="k";var SYMBOLS="pnbrqkPNBRQK";var DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var POSSIBLE_RESULTS=["1-0","0-1","1/2-1/2","*"];var PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]};var PIECE_OFFSETS={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]};var ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20];var RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17];var SHIFTS={p:0,n:1,b:2,r:3,q:4,k:5};var FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64};var RANK_1=7;var RANK_2=6;var RANK_3=5;var RANK_4=4;var RANK_5=3;var RANK_6=2;var RANK_7=1;var RANK_8=0;var SQUARES={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119};var ROOKS={w:[{square:SQUARES.a1,flag:BITS.QSIDE_CASTLE},{square:SQUARES.h1,flag:BITS.KSIDE_CASTLE}],b:[{square:SQUARES.a8,flag:BITS.QSIDE_CASTLE},{square:SQUARES.h8,flag:BITS.KSIDE_CASTLE}]};var board=new Array(128);var kings={w:EMPTY,b:EMPTY};var turn=WHITE;var castling={w:0,b:0};var ep_square=EMPTY;var half_moves=0;var move_number=1;var history=[];var header={};if(typeof fen==="undefined"){load(DEFAULT_POSITION)}else{load(fen)}function clear(){board=new Array(128);kings={w:EMPTY,b:EMPTY};turn=WHITE;castling={w:0,b:0};ep_square=EMPTY;half_moves=0;move_number=1;history=[];header={};update_setup(generate_fen())}function reset(){load(DEFAULT_POSITION)}function load(fen){var tokens=fen.split(/\s+/);var position=tokens[0];var square=0;var valid=SYMBOLS+"12345678/";if(!validate_fen(fen).valid){return false}clear();for(var i=0;i<position.length;i++){var piece=position.charAt(i);if(piece==="/"){square+=8}else if(is_digit(piece)){square+=parseInt(piece,10)}else{var color=piece<"a"?WHITE:BLACK;put({type:piece.toLowerCase(),color:color},algebraic(square));square++}}turn=tokens[1];if(tokens[2].indexOf("K")>-1){castling.w|=BITS.KSIDE_CASTLE}if(tokens[2].indexOf("Q")>-1){castling.w|=BITS.QSIDE_CASTLE}if(tokens[2].indexOf("k")>-1){castling.b|=BITS.KSIDE_CASTLE}if(tokens[2].indexOf("q")>-1){castling.b|=BITS.QSIDE_CASTLE}ep_square=tokens[3]==="-"?EMPTY:SQUARES[tokens[3]];half_moves=parseInt(tokens[4],10);move_number=parseInt(tokens[5],10);update_setup(generate_fen());return true}function validate_fen(fen){var errors={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."};var tokens=fen.split(/\s+/);if(tokens.length!==6){return{valid:false,error_number:1,error:errors[1]}}if(isNaN(tokens[5])||parseInt(tokens[5],10)<=0){return{valid:false,error_number:2,error:errors[2]}}if(isNaN(tokens[4])||parseInt(tokens[4],10)<0){return{valid:false,error_number:3,error:errors[3]}}if(!/^(-|[abcdefgh][36])$/.test(tokens[3])){return{valid:false,error_number:4,error:errors[4]}}if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(tokens[2])){return{valid:false,error_number:5,error:errors[5]}}if(!/^(w|b)$/.test(tokens[1])){return{valid:false,error_number:6,error:errors[6]}}var rows=tokens[0].split("/");if(rows.length!==8){return{valid:false,error_number:7,error:errors[7]}}for(var i=0;i<rows.length;i++){var sum_fields=0;var previous_was_number=false;for(var k=0;k<rows[i].length;k++){if(!isNaN(rows[i][k])){if(previous_was_number){return{valid:false,error_number:8,error:errors[8]}}sum_fields+=parseInt(rows[i][k],10);previous_was_number=true}else{if(!/^[prnbqkPRNBQK]$/.test(rows[i][k])){return{valid:false,error_number:9,error:errors[9]}}sum_fields+=1;previous_was_number=false}}if(sum_fields!==8){return{valid:false,error_number:10,error:errors[10]}}}return{valid:true,error_number:0,error:errors[0]}}function generate_fen(){var empty=0;var fen="";for(var i=SQUARES.a8;i<=SQUARES.h1;i++){if(board[i]==null){empty++}else{if(empty>0){fen+=empty;empty=0}var color=board[i].color;var piece=board[i].type;fen+=color===WHITE?piece.toUpperCase():piece.toLowerCase()}if(i+1&136){if(empty>0){fen+=empty}if(i!==SQUARES.h1){fen+="/"}empty=0;i+=8}}var cflags="";if(castling[WHITE]&BITS.KSIDE_CASTLE){cflags+="K"}if(castling[WHITE]&BITS.QSIDE_CASTLE){cflags+="Q"}if(castling[BLACK]&BITS.KSIDE_CASTLE){cflags+="k"}if(castling[BLACK]&BITS.QSIDE_CASTLE){cflags+="q"}cflags=cflags||"-";var epflags=ep_square===EMPTY?"-":algebraic(ep_square);return[fen,turn,cflags,epflags,half_moves,move_number].join(" ")}function set_header(args){for(var i=0;i<args.length;i+=2){if(typeof args[i]==="string"&&typeof args[i+1]==="string"){header[args[i]]=args[i+1]}}return header}function update_setup(fen){if(history.length>0)return;if(fen!==DEFAULT_POSITION){header["SetUp"]=fen;header["FEN"]="1"}else{delete header["SetUp"];delete header["FEN"]}}function get(square){var piece=board[SQUARES[square]];return piece?{type:piece.type,color:piece.color}:null}function put(piece,square){if(!("type"in piece&&"color"in piece)){return false}if(SYMBOLS.indexOf(piece.type.toLowerCase())===-1){return false}if(!(square in SQUARES)){return false}var sq=SQUARES[square];board[sq]={type:piece.type,color:piece.color};if(piece.type===KING){kings[piece.color]=sq}update_setup(generate_fen());return true}function remove(square){var piece=get(square);board[SQUARES[square]]=null;if(piece&&piece.type===KING){kings[piece.color]=EMPTY}update_setup(generate_fen());return piece}function build_move(board,from,to,flags,promotion){var move={color:turn,from:from,to:to,flags:flags,piece:board[from].type};if(promotion){move.flags|=BITS.PROMOTION;move.promotion=promotion}if(board[to]){move.captured=board[to].type}else if(flags&BITS.EP_CAPTURE){move.captured=PAWN}return move}function generate_moves(options){function add_move(board,moves,from,to,flags){if(board[from].type===PAWN&&(rank(to)===RANK_8||rank(to)===RANK_1)){var pieces=[QUEEN,ROOK,BISHOP,KNIGHT];for(var i=0,len=pieces.length;i<len;i++){moves.push(build_move(board,from,to,flags,pieces[i]))}}else{moves.push(build_move(board,from,to,flags))}}var moves=[];var us=turn;var them=swap_color(us);var second_rank={b:RANK_7,w:RANK_2};var first_sq=SQUARES.a8;var last_sq=SQUARES.h1;var single_square=false;var legal=typeof options!=="undefined"&&"legal"in options?options.legal:true;if(typeof options!=="undefined"&&"square"in options){if(options.square in SQUARES){first_sq=last_sq=SQUARES[options.square];single_square=true}else{return[]}}for(var i=first_sq;i<=last_sq;i++){if(i&136){i+=7;continue}var piece=board[i];if(piece==null||piece.color!==us){continue}if(piece.type===PAWN){var square=i+PAWN_OFFSETS[us][0];if(board[square]==null){add_move(board,moves,i,square,BITS.NORMAL);var square=i+PAWN_OFFSETS[us][1];if(second_rank[us]===rank(i)&&board[square]==null){add_move(board,moves,i,square,BITS.BIG_PAWN)}}for(j=2;j<4;j++){var square=i+PAWN_OFFSETS[us][j];if(square&136)continue;if(board[square]!=null&&board[square].color===them){add_move(board,moves,i,square,BITS.CAPTURE)}else if(square===ep_square){add_move(board,moves,i,ep_square,BITS.EP_CAPTURE)}}}else{for(var j=0,len=PIECE_OFFSETS[piece.type].length;j<len;j++){var offset=PIECE_OFFSETS[piece.type][j];var square=i;while(true){square+=offset;if(square&136)break;if(board[square]==null){add_move(board,moves,i,square,BITS.NORMAL)}else{if(board[square].color===us)break;add_move(board,moves,i,square,BITS.CAPTURE);break}if(piece.type==="n"||piece.type==="k")break}}}}if(!single_square||last_sq===kings[us]){if(castling[us]&BITS.KSIDE_CASTLE){var castling_from=kings[us];var castling_to=castling_from+2;if(board[castling_from+1]==null&&board[castling_to]==null&&!attacked(them,kings[us])&&!attacked(them,castling_from+1)&&!attacked(them,castling_to)){add_move(board,moves,kings[us],castling_to,BITS.KSIDE_CASTLE)}}if(castling[us]&BITS.QSIDE_CASTLE){var castling_from=kings[us];var castling_to=castling_from-2;if(board[castling_from-1]==null&&board[castling_from-2]==null&&board[castling_from-3]==null&&!attacked(them,kings[us])&&!attacked(them,castling_from-1)&&!attacked(them,castling_to)){add_move(board,moves,kings[us],castling_to,BITS.QSIDE_CASTLE)}}}if(!legal){return moves}var legal_moves=[];for(var i=0,len=moves.length;i<len;i++){make_move(moves[i]);if(!king_attacked(us)){legal_moves.push(moves[i])}undo_move()}return legal_moves}function move_to_san(move){var output="";if(move.flags&BITS.KSIDE_CASTLE){output="O-O"}else if(move.flags&BITS.QSIDE_CASTLE){output="O-O-O"}else{var disambiguator=get_disambiguator(move);if(move.piece!==PAWN){output+=move.piece.toUpperCase()+disambiguator}if(move.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)){if(move.piece===PAWN){output+=algebraic(move.from)[0]}output+="x"}output+=algebraic(move.to);if(move.flags&BITS.PROMOTION){output+="="+move.promotion.toUpperCase()}}make_move(move);if(in_check()){if(in_checkmate()){output+="#"}else{output+="+"}}undo_move();return output}function attacked(color,square){for(var i=SQUARES.a8;i<=SQUARES.h1;i++){if(i&136){i+=7;continue}if(board[i]==null||board[i].color!==color)continue;var piece=board[i];var difference=i-square;var index=difference+119;if(ATTACKS[index]&1<<SHIFTS[piece.type]){if(piece.type===PAWN){if(difference>0){if(piece.color===WHITE)return true}else{if(piece.color===BLACK)return true}continue}if(piece.type==="n"||piece.type==="k")return true;var offset=RAYS[index];var j=i+offset;var blocked=false;while(j!==square){if(board[j]!=null){blocked=true;break}j+=offset}if(!blocked)return true}}return false}function king_attacked(color){return attacked(swap_color(color),kings[color])}function in_check(){return king_attacked(turn)}function in_checkmate(){return in_check()&&generate_moves().length===0}function in_stalemate(){return!in_check()&&generate_moves().length===0}function insufficient_material(){var pieces={};var bishops=[];var num_pieces=0;var sq_color=0;for(var i=SQUARES.a8;i<=SQUARES.h1;i++){sq_color=(sq_color+1)%2;if(i&136){i+=7;continue}var piece=board[i];if(piece){pieces[piece.type]=piece.type in pieces?pieces[piece.type]+1:1;if(piece.type===BISHOP){bishops.push(sq_color)}num_pieces++}}if(num_pieces===2){return true}else if(num_pieces===3&&(pieces[BISHOP]===1||pieces[KNIGHT]===1)){return true}else if(num_pieces===pieces[BISHOP]+2){var sum=0;var len=bishops.length;for(var i=0;i<len;i++){sum+=bishops[i]}if(sum===0||sum===len){return true}}return false}function in_threefold_repetition(){var moves=[];var positions={};var repetition=false;while(true){var move=undo_move();if(!move)break;moves.push(move)}while(true){var fen=generate_fen().split(" ").slice(0,4).join(" ");positions[fen]=fen in positions?positions[fen]+1:1;if(positions[fen]>=3){repetition=true}if(!moves.length){break}make_move(moves.pop())}return repetition}function push(move){history.push({move:move,kings:{b:kings.b,w:kings.w},turn:turn,castling:{b:castling.b,w:castling.w},ep_square:ep_square,half_moves:half_moves,move_number:move_number})}function make_move(move){var us=turn;var them=swap_color(us);push(move);board[move.to]=board[move.from];board[move.from]=null;if(move.flags&BITS.EP_CAPTURE){if(turn===BLACK){board[move.to-16]=null}else{board[move.to+16]=null}}if(move.flags&BITS.PROMOTION){board[move.to]={type:move.promotion,color:us}}if(board[move.to].type===KING){kings[board[move.to].color]=move.to;if(move.flags&BITS.KSIDE_CASTLE){var castling_to=move.to-1;var castling_from=move.to+1;board[castling_to]=board[castling_from];board[castling_from]=null}else if(move.flags&BITS.QSIDE_CASTLE){var castling_to=move.to+1;var castling_from=move.to-2;board[castling_to]=board[castling_from];board[castling_from]=null}castling[us]=""}if(castling[us]){for(var i=0,len=ROOKS[us].length;i<len;i++){if(move.from===ROOKS[us][i].square&&castling[us]&ROOKS[us][i].flag){castling[us]^=ROOKS[us][i].flag;break}}}if(castling[them]){for(var i=0,len=ROOKS[them].length;i<len;i++){if(move.to===ROOKS[them][i].square&&castling[them]&ROOKS[them][i].flag){castling[them]^=ROOKS[them][i].flag;break}}}if(move.flags&BITS.BIG_PAWN){if(turn==="b"){ep_square=move.to-16}else{ep_square=move.to+16}}else{ep_square=EMPTY}if(move.piece===PAWN){half_moves=0}else if(move.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)){half_moves=0}else{half_moves++}if(turn===BLACK){move_number++}turn=swap_color(turn)}function undo_move(){var old=history.pop();if(old==null){return null}var move=old.move;kings=old.kings;turn=old.turn;castling=old.castling;ep_square=old.ep_square;half_moves=old.half_moves;move_number=old.move_number;var us=turn;var them=swap_color(turn);board[move.from]=board[move.to];board[move.from].type=move.piece;board[move.to]=null;if(move.flags&BITS.CAPTURE){board[move.to]={type:move.captured,color:them}}else if(move.flags&BITS.EP_CAPTURE){var index;if(us===BLACK){index=move.to-16}else{index=move.to+16}board[index]={type:PAWN,color:them}}if(move.flags&(BITS.KSIDE_CASTLE|BITS.QSIDE_CASTLE)){var castling_to,castling_from;if(move.flags&BITS.KSIDE_CASTLE){castling_to=move.to+1;castling_from=move.to-1}else if(move.flags&BITS.QSIDE_CASTLE){castling_to=move.to-2;castling_from=move.to+1}board[castling_to]=board[castling_from];board[castling_from]=null}return move}function get_disambiguator(move){var moves=generate_moves();var from=move.from;var to=move.to;var piece=move.piece;var ambiguities=0;var same_rank=0;var same_file=0;for(var i=0,len=moves.length;i<len;i++){var ambig_from=moves[i].from;var ambig_to=moves[i].to;var ambig_piece=moves[i].piece;if(piece===ambig_piece&&from!==ambig_from&&to===ambig_to){ambiguities++;if(rank(from)===rank(ambig_from)){same_rank++}if(file(from)===file(ambig_from)){same_file++}}}if(ambiguities>0){if(same_rank>0&&same_file>0){return algebraic(from)}else if(same_file>0){return algebraic(from).charAt(1)}else{return algebraic(from).charAt(0)}}return""}function ascii(){var s="   +------------------------+\n";for(var i=SQUARES.a8;i<=SQUARES.h1;i++){if(file(i)===0){s+=" "+"87654321"[rank(i)]+" |"}if(board[i]==null){s+=" . "}else{var piece=board[i].type;var color=board[i].color;var symbol=color===WHITE?piece.toUpperCase():piece.toLowerCase();s+=" "+symbol+" "}if(i+1&136){s+="|\n";i+=8}}s+="   +------------------------+\n";s+="     a  b  c  d  e  f  g  h\n";return s}function rank(i){return i>>4}function file(i){return i&15}function algebraic(i){var f=file(i),r=rank(i);return"abcdefgh".substring(f,f+1)+"87654321".substring(r,r+1)}function swap_color(c){return c===WHITE?BLACK:WHITE}function is_digit(c){return"0123456789".indexOf(c)!==-1}function make_pretty(ugly_move){var move=clone(ugly_move);move.san=move_to_san(move);move.to=algebraic(move.to);move.from=algebraic(move.from);var flags="";for(var flag in BITS){if(BITS[flag]&move.flags){flags+=FLAGS[flag]}}move.flags=flags;return move}function clone(obj){var dupe=obj instanceof Array?[]:{};for(var property in obj){if(typeof property==="object"){dupe[property]=clone(obj[property])}else{dupe[property]=obj[property]}}return dupe}function trim(str){return str.replace(/^\s+|\s+$/g,"")}function perft(depth){var moves=generate_moves({legal:false});var nodes=0;var color=turn;for(var i=0,len=moves.length;i<len;i++){make_move(moves[i]);if(!king_attacked(color)){if(depth-1>0){var child_nodes=perft(depth-1);nodes+=child_nodes}else{nodes++}}undo_move()}return nodes}return{WHITE:WHITE,BLACK:BLACK,PAWN:PAWN,KNIGHT:KNIGHT,BISHOP:BISHOP,ROOK:ROOK,QUEEN:QUEEN,KING:KING,SQUARES:function(){var keys=[];for(var i=SQUARES.a8;i<=SQUARES.h1;i++){if(i&136){i+=7;continue}keys.push(algebraic(i))}return keys}(),FLAGS:FLAGS,load:function(fen){return load(fen)},reset:function(){return reset()},moves:function(options){var ugly_moves=generate_moves(options);var moves=[];for(var i=0,len=ugly_moves.length;i<len;i++){if(typeof options!=="undefined"&&"verbose"in options&&options.verbose){moves.push(make_pretty(ugly_moves[i]))}else{moves.push(move_to_san(ugly_moves[i]))}}return moves},in_check:function(){return in_check()},in_checkmate:function(){return in_checkmate()},in_stalemate:function(){return in_stalemate()},in_draw:function(){return half_moves>=100||in_stalemate()||insufficient_material()||in_threefold_repetition()},insufficient_material:function(){return insufficient_material()},in_threefold_repetition:function(){return in_threefold_repetition()},game_over:function(){return half_moves>=100||in_checkmate()||in_stalemate()||insufficient_material()||in_threefold_repetition()},validate_fen:function(fen){return validate_fen(fen)},fen:function(){return generate_fen()},pgn:function(options){var newline=typeof options==="object"&&typeof options.newline_char==="string"?options.newline_char:"\n";var max_width=typeof options==="object"&&typeof options.max_width==="number"?options.max_width:0;var result=[];var header_exists=false;for(var i in header){result.push("["+i+' "'+header[i]+'"]'+newline);header_exists=true}if(header_exists&&history.length){result.push(newline)}var reversed_history=[];while(history.length>0){reversed_history.push(undo_move())}var moves=[];var move_string="";var pgn_move_number=1;while(reversed_history.length>0){var move=reversed_history.pop();if(pgn_move_number===1&&move.color==="b"){move_string="1. ...";pgn_move_number++}else if(move.color==="w"){if(move_string.length){moves.push(move_string)}move_string=pgn_move_number+".";pgn_move_number++}move_string=move_string+" "+move_to_san(move);make_move(move)}if(move_string.length){moves.push(move_string)}if(typeof header.Result!=="undefined"){moves.push(header.Result)}if(max_width===0){return result.join("")+moves.join(" ")}var current_width=0;for(var i=0;i<moves.length;i++){if(current_width+moves[i].length>max_width&&i!==0){if(result[result.length-1]===" "){result.pop()}result.push(newline);current_width=0}else if(i!==0){result.push(" ");current_width++}result.push(moves[i]);current_width+=moves[i].length}return result.join("")},load_pgn:function(pgn,options){function mask(str){return str.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function move_from_san(move){var to,from,flags=BITS.NORMAL,promotion;var parse=move.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=?[NBRQ])?/);if(move.slice(0,5)==="O-O-O"){from=kings[turn];to=from-2;flags=BITS.QSIDE_CASTLE}else if(move.slice(0,3)==="O-O"){from=kings[turn];to=from+2;flags=BITS.KSIDE_CASTLE}else if(parse&&parse[1]){var piece=parse[1].toLowerCase();if(parse[3]){flags=BITS.CAPTURE}to=SQUARES[parse[4]];for(var j=0,len=PIECE_OFFSETS[piece].length;j<len;j++){var offset=PIECE_OFFSETS[piece][j];var square=to;while(true){square+=offset;if(square&136)break;var b=board[square];if(b){if(b.color===turn&&b.type===piece&&(!parse[2]||algebraic(square).indexOf(parse[2])>=0)){from=square}break}if(piece==="n"||piece==="k")break}}}else if(parse){if(parse[3]){to=SQUARES[parse[4]];for(var j=2;j<4;j++){var square=to-PAWN_OFFSETS[turn][j];if(square&136)continue;if(board[square]!=null&&board[square].color===turn&&algebraic(square)[0]===parse[2]){from=square}}if(board[to]){flags=BITS.CAPTURE}else{flags=BITS.EP_CAPTURE}}else{to=SQUARES[move.slice(0,2)];var c=to-PAWN_OFFSETS[turn][0],b=board[c];if(b&&b.type===PAWN&&b.color===turn){from=c}else{c=to-PAWN_OFFSETS[turn][1];b=board[c];if(b&&b.type===PAWN&&b.color===turn){from=c;flags=BITS.BIG_PAWN}}}if(parse[5]){if(typeof parse[5][1]=="undefined"){promotion=parse[5][0].toLowerCase()}else{promotion=parse[5][1].toLowerCase()}}}if(from>=0&&to>=0&&flags){return build_move(board,from,to,flags,promotion)}else if(move.length>0){}}function get_move_obj(move){return move_from_san(trim(move))}function has_keys(object){var has_keys=false;for(var key in object){has_keys=true}return has_keys}function parse_pgn_header(header,options){var newline_char=typeof options==="object"&&typeof options.newline_char==="string"?options.newline_char:"\r?\n";var header_obj={};var headers=header.split(newline_char);var key="";var value="";for(var i=0;i<headers.length;i++){key=headers[i].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1");value=headers[i].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1");if(trim(key).length>0){header_obj[key]=value}}return header_obj}var newline_char=typeof options==="object"&&typeof options.newline_char==="string"?options.newline_char:"\r?\n";var regex=new RegExp("^(\\[(.|"+mask(newline_char)+")*\\])"+"("+mask(newline_char)+")*"+"1.("+mask(newline_char)+"|.)*$","g");var header_string=pgn.replace(regex,"$1");if(header_string[0]!=="["){header_string=""}reset();var headers=parse_pgn_header(header_string,options);for(var key in headers){set_header([key,headers[key]])}var ms=pgn.replace(header_string,"").replace(new RegExp(mask(newline_char),"g")," ");ms=ms.replace(/(\{[^}]+\})+?/g,"");ms=ms.replace(/\d+\./g,"");var moves=trim(ms).split(new RegExp(/\s+/));moves=moves.join(",").replace(/,,+/g,",").split(",");var move="";for(var half_move=0;half_move<moves.length-1;half_move++){move=get_move_obj(moves[half_move]);if(move==null){return false}else{make_move(move)}}move=moves[moves.length-1];if(POSSIBLE_RESULTS.indexOf(move)>-1){if(has_keys(header)&&typeof header.Result==="undefined"){set_header(["Result",move])}}else{move=get_move_obj(move);if(move==null){return false}else{make_move(move)}}return true},header:function(){return set_header(arguments)},ascii:function(){return ascii()},turn:function(){return turn},move:function(move){var move_obj=null;var moves=generate_moves();if(typeof move==="string"){for(var i=0,len=moves.length;i<len;i++){if(move===move_to_san(moves[i])){move_obj=moves[i];break}}}else if(typeof move==="object"){for(var i=0,len=moves.length;i<len;i++){if(move.from===algebraic(moves[i].from)&&move.to===algebraic(moves[i].to)&&(!("promotion"in moves[i])||move.promotion===moves[i].promotion)){move_obj=moves[i];break}}}if(!move_obj){return null}var pretty_move=make_pretty(move_obj);make_move(move_obj);return pretty_move},undo:function(){var move=undo_move();return move?make_pretty(move):null},clear:function(){return clear()},put:function(piece,square){return put(piece,square)},get:function(square){return get(square)},remove:function(square){return remove(square)},perft:function(depth){return perft(depth)},square_color:function(square){if(square in SQUARES){var sq_0x88=SQUARES[square];return(rank(sq_0x88)+file(sq_0x88))%2===0?"light":"dark"}return null},history:function(options){var reversed_history=[];var move_history=[];var verbose=typeof options!=="undefined"&&"verbose"in options&&options.verbose;while(history.length>0){reversed_history.push(undo_move())}while(reversed_history.length>0){var move=reversed_history.pop();if(verbose){move_history.push(make_pretty(move))}else{move_history.push(move_to_san(move))}make_move(move)}return move_history}}};if(typeof exports!=="undefined")exports.Chess=Chess;(function(window,document,undefined){var _MAP={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},_KEYCODE_MAP={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},_SHIFT_MAP={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},_SPECIAL_ALIASES={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},_REVERSE_MAP,_callbacks={},_directMap={},_sequenceLevels={},_resetTimer,_ignoreNextKeyup=false,_ignoreNextKeypress=false,_nextExpectedAction=false;for(var i=1;i<20;++i){_MAP[111+i]="f"+i}for(i=0;i<=9;++i){_MAP[i+96]=i}function _addEvent(object,type,callback){if(object.addEventListener){object.addEventListener(type,callback,false);return}object.attachEvent("on"+type,callback)}function _characterFromEvent(e){if(e.type=="keypress"){var character=String.fromCharCode(e.which);if(!e.shiftKey){character=character.toLowerCase()}return character}if(_MAP[e.which]){return _MAP[e.which]}if(_KEYCODE_MAP[e.which]){return _KEYCODE_MAP[e.which]}return String.fromCharCode(e.which).toLowerCase()}function _modifiersMatch(modifiers1,modifiers2){return modifiers1.sort().join(",")===modifiers2.sort().join(",")}function _resetSequences(doNotReset){doNotReset=doNotReset||{};var activeSequences=false,key;for(key in _sequenceLevels){if(doNotReset[key]){activeSequences=true;continue}_sequenceLevels[key]=0}if(!activeSequences){_nextExpectedAction=false}}function _getMatches(character,modifiers,e,sequenceName,combination,level){var i,callback,matches=[],action=e.type;if(!_callbacks[character]){return[]}if(action=="keyup"&&_isModifier(character)){modifiers=[character]}for(i=0;i<_callbacks[character].length;++i){callback=_callbacks[character][i];if(!sequenceName&&callback.seq&&_sequenceLevels[callback.seq]!=callback.level){continue}if(action!=callback.action){continue}if(action=="keypress"&&!e.metaKey&&!e.ctrlKey||_modifiersMatch(modifiers,callback.modifiers)){var deleteCombo=!sequenceName&&callback.combo==combination;var deleteSequence=sequenceName&&callback.seq==sequenceName&&callback.level==level;if(deleteCombo||deleteSequence){_callbacks[character].splice(i,1)}matches.push(callback)}}return matches}function _eventModifiers(e){var modifiers=[];if(e.shiftKey){modifiers.push("shift")}if(e.altKey){modifiers.push("alt")}if(e.ctrlKey){modifiers.push("ctrl")}if(e.metaKey){modifiers.push("meta")}return modifiers}function _fireCallback(callback,e,combo,sequence){if(Mousetrap.stopCallback(e,e.target||e.srcElement,combo,sequence)){return}if(callback(e,combo)===false){if(e.preventDefault){e.preventDefault()}if(e.stopPropagation){e.stopPropagation()}e.returnValue=false;e.cancelBubble=true}}function _handleKey(character,modifiers,e){var callbacks=_getMatches(character,modifiers,e),i,doNotReset={},maxLevel=0,processedSequenceCallback=false;for(i=0;i<callbacks.length;++i){if(callbacks[i].seq){maxLevel=Math.max(maxLevel,callbacks[i].level)}}for(i=0;i<callbacks.length;++i){if(callbacks[i].seq){if(callbacks[i].level!=maxLevel){continue}processedSequenceCallback=true;doNotReset[callbacks[i].seq]=1;_fireCallback(callbacks[i].callback,e,callbacks[i].combo,callbacks[i].seq);continue}if(!processedSequenceCallback){_fireCallback(callbacks[i].callback,e,callbacks[i].combo)}}var ignoreThisKeypress=e.type=="keypress"&&_ignoreNextKeypress;if(e.type==_nextExpectedAction&&!_isModifier(character)&&!ignoreThisKeypress){_resetSequences(doNotReset)}_ignoreNextKeypress=processedSequenceCallback&&e.type=="keydown"}function _handleKeyEvent(e){if(typeof e.which!=="number"){e.which=e.keyCode}var character=_characterFromEvent(e);if(!character){return}if(e.type=="keyup"&&_ignoreNextKeyup===character){_ignoreNextKeyup=false;return}Mousetrap.handleKey(character,_eventModifiers(e),e)}function _isModifier(key){return key=="shift"||key=="ctrl"||key=="alt"||key=="meta"}function _resetSequenceTimer(){clearTimeout(_resetTimer);_resetTimer=setTimeout(_resetSequences,1e3)}function _getReverseMap(){if(!_REVERSE_MAP){_REVERSE_MAP={};for(var key in _MAP){if(key>95&&key<112){continue}if(_MAP.hasOwnProperty(key)){_REVERSE_MAP[_MAP[key]]=key}}}return _REVERSE_MAP}function _pickBestAction(key,modifiers,action){if(!action){action=_getReverseMap()[key]?"keydown":"keypress"}if(action=="keypress"&&modifiers.length){action="keydown"}return action}function _bindSequence(combo,keys,callback,action){_sequenceLevels[combo]=0;function _increaseSequence(nextAction){return function(){_nextExpectedAction=nextAction;++_sequenceLevels[combo];_resetSequenceTimer()}}function _callbackAndReset(e){_fireCallback(callback,e,combo);if(action!=="keyup"){_ignoreNextKeyup=_characterFromEvent(e)}setTimeout(_resetSequences,10)}for(var i=0;i<keys.length;++i){var isFinal=i+1===keys.length;var wrappedCallback=isFinal?_callbackAndReset:_increaseSequence(action||_getKeyInfo(keys[i+1]).action);_bindSingle(keys[i],wrappedCallback,action,combo,i)}}function _keysFromString(combination){if(combination==="+"){return["+"]}return combination.split("+")}function _getKeyInfo(combination,action){var keys,key,i,modifiers=[];keys=_keysFromString(combination);for(i=0;i<keys.length;++i){key=keys[i];if(_SPECIAL_ALIASES[key]){key=_SPECIAL_ALIASES[key]}if(action&&action!="keypress"&&_SHIFT_MAP[key]){key=_SHIFT_MAP[key];modifiers.push("shift")}if(_isModifier(key)){modifiers.push(key)}}action=_pickBestAction(key,modifiers,action);return{key:key,modifiers:modifiers,action:action}}function _bindSingle(combination,callback,action,sequenceName,level){_directMap[combination+":"+action]=callback;combination=combination.replace(/\s+/g," ");var sequence=combination.split(" "),info;if(sequence.length>1){_bindSequence(combination,sequence,callback,action);return}info=_getKeyInfo(combination,action);_callbacks[info.key]=_callbacks[info.key]||[];_getMatches(info.key,info.modifiers,{type:info.action},sequenceName,combination,level);_callbacks[info.key][sequenceName?"unshift":"push"]({callback:callback,modifiers:info.modifiers,action:info.action,seq:sequenceName,level:level,combo:combination})}function _bindMultiple(combinations,callback,action){for(var i=0;i<combinations.length;++i){_bindSingle(combinations[i],callback,action)}}_addEvent(document,"keypress",_handleKeyEvent);_addEvent(document,"keydown",_handleKeyEvent);_addEvent(document,"keyup",_handleKeyEvent);var Mousetrap={bind:function(keys,callback,action){keys=keys instanceof Array?keys:[keys];_bindMultiple(keys,callback,action);return this},unbind:function(keys,action){return Mousetrap.bind(keys,function(){},action)},trigger:function(keys,action){if(_directMap[keys+":"+action]){_directMap[keys+":"+action]({},keys)}return this},reset:function(){_callbacks={};_directMap={};return this},stopCallback:function(e,element){if((" "+element.className+" ").indexOf(" mousetrap ")>-1){return false}return element.tagName=="INPUT"||element.tagName=="SELECT"||element.tagName=="TEXTAREA"||element.isContentEditable},handleKey:_handleKey};window.Mousetrap=Mousetrap;if(typeof define==="function"&&define.amd){define(Mousetrap)}})(window,document);(function(){"use strict";$.extend(CC,{random_minute:function(min,max){return(Math.floor(Math.random()*(max-min+1))+min)*6e4
},classify_opening:function(moves){var game=new Chess;var movetext="";var op_moves,op_fen;$.each(moves,function(i,v){if(i===0){movetext+="1."}else if(i%2===0){movetext+=i/2+1+"."}movetext+=v+" ";game.move(v);var cur_opening=CC.openings[movetext.trim()];if(cur_opening){op_moves=cur_opening}var cur_fen=CC.openings[CC.openings_fen[game.fen()]];if(cur_fen){op_fen=cur_fen}});return{moves:op_moves,fen:op_fen}},get_opening:function(override_cache){var notation=$('div[id^="notation_"]:visible');if(!notation.length){$("#ccutils_opening_moves").text("Notation window not visible.");$("#ccutils_opening_fen").text("");return}if(notation.length>1){$("#ccutils_opening_moves").text("Cannot run when games popped-out.");$("#ccutils_opening_fen").text(":(");return}var game_id=window.location.hash.replace(/#(g|a)=/,"");if(CC.analyzed_games_cache[game_id]&&CC.analyzed_games_cache[game_id].count>4&&CC.analyzed_games_cache[game_id].opening!="N/A"&&CC.analyzed_games_cache[game_id].num_moves>16&&!override_cache){$("#ccutils_opening_moves").text(CC.analyzed_games_cache[game_id].opening);$("#ccutils_opening_fen").text(CC.analyzed_games_cache[game_id].fen);return}var moves=[];var notations;notations=notation.find(".notationVertical");if(notations.length){notations.each(function(i,v){$(v).find(".gotomove").each(function(ii,n){moves.push($(n).text())})})}else{notations=notation.find(".notationHorizontal");if(notations.length){notations.each(function(i,v){$(v).find(".gotomove").each(function(ii,n){var regx=$(n).text().match(/\d*\.\s*(.*)/);if(regx){moves.push(regx[1])}else{moves.push($(n).text())}})})}}var opening=CC.classify_opening(moves);var new_opening_text,new_fen_text;if(opening.moves){new_opening_text="Opening: "+opening.moves.eco+": "+" "+opening.moves.name+" ("+opening.moves.moves+")"}else{new_opening_text="N/A"}if(opening.fen){new_fen_text="Position: "+opening.fen.eco+": "+" "+opening.fen.name+" ("+opening.fen.moves+")"}else{new_fen_text="N/A"}var count=1;if(CC.analyzed_games_cache[game_id]&&CC.analyzed_games_cache[game_id].opening==new_opening_text&&CC.analyzed_games_cache[game_id].fen==new_fen_text){count=CC.analyzed_games_cache[game_id].count+1}CC.analyzed_games_cache[game_id]={opening:new_opening_text,fen:new_fen_text,count:count,num_moves:moves.length};if($("#ccutils_opening_moves").text()!=new_opening_text){$("#ccutils_opening_moves").text(new_opening_text)}if($("#ccutils_opening_fen").text()!=new_fen_text){$("#ccutils_opening_fen").text(new_fen_text)}return opening},opening_refresh:function(){CC.game_all_channel=cometd.addListener("/game/*",function(msg){CC.get_opening(msg)})},flash_keyboard_icon:function(){$("#ccutils_keyboard_icon").animate({opacity:1},100).animate({opacity:.3},100)},announce_opening:function(){var opening=CC.get_opening(true);if(!opening){return}var announce_text;console.log("ran");if(opening.moves.name==opening.fen.name){announce_text="Opening: ("+opening.moves.eco+") "+opening.moves.name}else{announce_text="Position: ("+opening.fen.eco+") "+opening.fen.name+", transposed from Opening: ("+opening.moves.eco+") "+opening.moves.name}$(".chatInputGameWrapper input[id^=chatInput_]:visible").first().val(announce_text);$(".chatInputGameWrapper button[id^=chatInputButton_]").click();CC.flash_keyboard_icon();CC.last_chat=Math.round((new Date).getTime()/1e3)+5}});CC.opening_checker=setInterval(CC.get_opening,5e3);CC.analyzed_games_cache={};setInterval(function(){CC.analyzed_games_cache={}},3e5);CC.opening_refresh();var div_wrapper=$("<div/>").attr("id","ccutils_wrapper").css({position:"fixed",top:35,"z-index":9,color:"white",height:"28px",width:"100%"}).appendTo(body);var div_opening=$("<div/>").attr("id","ccutils_opening").css({"background-color":"#6a943f",margin:"0px 5px",height:"100%","border-radius":"5px 5px 0px 0px","border-top":"1px solid #799e52","border-bottom":"1px solid #4c7637","padding-left":"5px"}).appendTo(div_wrapper).click(CC.get_opening);var div_opening_moves=$("<p/>").attr({id:"ccutils_opening_moves",title:"Opening classification according to the move order."}).css({"font-size":"12px","line-height":"14px"}).appendTo(div_opening);var div_opening_fen=$("<p/>").attr({id:"ccutils_opening_fen",title:"Opening classification according to the game position."}).css({"font-size":"12px","line-height":"14px"}).appendTo(div_opening);var keyboard_icon=$("<div/>").attr("id","ccutils_keyboard_icon").css({"background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACEUlEQVRYhe3WMUhVURgH8N8xEZGIBgmRiKjFJFpqiIoWy6GhNVocm4qWkJpEJGoLXJormhtU2iKCBhscKiJaopJKCbEQCTFPw/2eXV/vYQ96vOV9l8O9/+/7zjn/+53/PeemLGuldbR09jaBNoE2AXRWHpJ0CuM40MT51nAPk1legVTZiJL0GMN400QCe9CDoSy/oFQB7MUKTuJnkwhMYBS7K45aGliP1oGNLK+V8HpgkOW1wOXcjarc6tgWqyfCM/iCa4EvYwHnk9SLKcwmqTdJxyM2kaQO3Im+A5G7gIf1StJZx7+MOXwO/DXwkkJI77AYlVmJ2IfIfR94NcbfhZ31CMhx4RW+oydwR6WVcrbFVbF+ZMyE71bg4UpezQokaRBXSngmy9MYwaEk3cUP3MAnTCbpNC4k6UFU4DoO1n3zsHpLsB+X/NHIEqZxVqGPRwpBjeA1JnEk+syG7yIGov96owSeVLFfjvtVdCvWfwNHS4PfD5LfFOs/hK6IrTZKoBt9mM/yfJL6knSiFN9XTk5SeffsD3IvFYI9pqjgYs2ZaokQ5xRiGY/YaOBG2mHFzpcx1ZAIFZ/ZGJ4GfhZ4O9uBX1GBRcUnOoa39TrUItCFj7gNSepSqHruHwjUsvI4f81XdsxjEM/V2DL/k/UpqlIR9RYCNxVv38zjeElxHG+euJvHcaus5X9EbQJtAm0CvwEi8Mhr8HnPPAAAAABJRU5ErkJggg==')",position:"fixed",top:34,right:10,"z-index":9,height:32,width:32,opacity:.3}).attr("title",' Key Bindings:\n   "shift+c s" Seek Game\n   "shift+c d" Offer Draw\n   "shift+c r" Resign\n   "shift+c shift+r" Clean Refresh\n   "shift+c shift+a" Announce Opening').appendTo(body);var checkmousetrap=setInterval(function(){if(Mousetrap){clearInterval(checkmousetrap);Mousetrap.bind("shift+c s",function(){CC.flash_keyboard_icon();$("#new_game_pane_create_button").click()});Mousetrap.bind("shift+c d",function(){if(!$("input[id^=b-draw]:visible").get(0)){return}CC.flash_keyboard_icon();$("input[id^=b-draw]:visible").click()});Mousetrap.bind("shift+c r",function(){if(!$("input[id^=b-resign-abort]:visible").get(0)){return}CC.flash_keyboard_icon();$("input[id^=b-resign-abort]:visible").click()});Mousetrap.bind("shift+c shift+r",function(){CC.flash_keyboard_icon();$(".nowrapTabStrip .dijitTabCloseButton").click();setTimeout(function(){window.location="http://live.chess.com/live"},350)});Mousetrap.bind("shift+c shift+a",function(){CC.announce_opening()})}},300)})();