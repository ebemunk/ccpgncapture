(function(){"use strict";window.CC={classify_opening:function(moves){var game=new Chess;var movetext="";var op_moves,op_fen;$.each(moves,function(i,v){if(i==0){movetext+="1."}else if(i%2==0){movetext+=i/2+1+"."}movetext+=v+" ";game.move(v);var cur_opening=CC.openings[movetext.trim()];if(cur_opening){op_moves=cur_opening}var cur_fen=CC.openings_fen[game.fen()];if(cur_fen){op_fen=cur_fen}});return{moves:op_moves,fen:op_fen}},get_opening:function(){var notation=$('div[id^="notation_"]:visible');if(!notation.length){$("#ccutils_opening_moves").text("Notation window not visible.");$("#ccutils_opening_fen").text("");return}var moves=[];notation.find(".notationVertical").each(function(i,v){$(v).find(".gotomove").each(function(ii,n){moves.push($(n).text())})});var opening=CC.classify_opening(moves);var new_opening_text,new_fen_text;if(opening.moves){new_opening_text="Opening: "+opening.moves.eco+": "+" "+opening.moves.name+" ("+opening.moves.moves+")";if($("#ccutils_opening_moves").text()!=new_opening_text){$("#ccutils_opening_moves").text(new_opening_text)}}else{$("#ccutils_opening_moves").text("Opening: N/A")}if(opening.fen){new_fen_text="Position: "+opening.fen.eco+": "+" "+opening.fen.name+" ("+opening.fen.moves+")";if($("#ccutils_opening_fen").text()!=new_fen_text){$("#ccutils_opening_fen").text(new_fen_text)}}else{$("#ccutils_opening_fen").text("Position: N/A")}},decode:{a:"a1",i:"a2",q:"a3",y:"a4",G:"a5",O:"a6",W:"a7",4:"a8",b:"b1",j:"b2",r:"b3",z:"b4",H:"b5",P:"b6",X:"b7",5:"b8",c:"c1",k:"c2",s:"c3",A:"c4",I:"c5",Q:"c6",Y:"c7",6:"c8",d:"d1",l:"d2",t:"d3",B:"d4",J:"d5",R:"d6",Z:"d7",7:"d8",e:"e1",m:"e2",u:"e3",C:"e4",K:"e5",S:"e6",0:"e7",8:"e8",f:"f1",n:"f2",v:"f3",D:"f4",L:"f5",T:"f6",1:"f7",9:"f8",g:"g1",o:"g2",w:"g3",E:"g4",M:"g5",U:"g6",2:"g7","!":"g8",h:"h1",p:"h2",x:"h3",F:"h4",N:"h5",V:"h6",3:"h7","?":"h8"},promotions:{"{":[-1,"q"],"~":[0,"q"],"}":[1,"q"],"(":[-1,"n"],"^":[0,"n"],")":[1,"n"],"[":[-1,"r"],_:[0,"r"],"]":[1,"r"],"@":[-1,"b"],"#":[0,"b"],$:[1,"b"]},decode_moves:function(moves){var game=new Chess;var is_white=true;for(var i=0;i<moves.length-1;i+=2){var from=moves[i];from=CC.decode[from];var to=moves[i+1];var promotion="";var direction=is_white?1:-1;if(to in CC.promotions){promotion=CC.promotions[to][1];var to_file=String.fromCharCode(from.charCodeAt(0)+CC.promotions[to][0]);var to_rank=String.fromCharCode(from.charCodeAt(1)+direction);to=to_file+to_rank}else{to=CC.decode[to]}game.move({from:from,to:to,promotion:promotion});is_white=!is_white}return game},listen:function(msg){if(msg.data.game.status=="finished"){var game=CC.decode_moves(msg.data.game.moves);var game_opening=CC.classify_opening(game.history());var date=new Date;var month=date.getMonth()+1;var day=date.getDate();var date_str=date.getFullYear()+"."+((""+month).length<2?"0":"")+month+"."+((""+day).length<2?"0":"")+day;var result;var loser=false,winner=false;if(msg.data.game.results[0]=="win"){result="1-0";winner=0;loser=1}else if(msg.data.game.results[1]=="win"){result="0-1";winner=1;loser=0}else{result="1/2-1/2"}var termination;switch(msg.data.game.results[loser]){case"resigned":termination=msg.data.game.players[winner].uid+" won by resignation.";break;case"timeout":termination=msg.data.game.players[winner].uid+" won on time.";break;case"checkmated":termination=msg.data.game.players[winner].uid+" won by checkmate.";break;case"abandoned":termination=msg.data.game.players[winner].uid+" won - game abandoned.";break;case"agreed":termination="Game drawn by agreement.";break;case"stalemate":termination="Game drawn by stalemate.";break;case"repetition":termination="Game drawn by repetition.";break;case"insufficient":termination="Game drawn - insufficient material.";break}game.header("Event","Live Chess","Site","Chess.com","Date",date_str,"White",msg.data.game.players[0].uid,"Black",msg.data.game.players[1].uid,"Result",result,"WhiteElo",msg.data.ratings[0],"BlackElo",msg.data.ratings[1],"Termination",termination,"ECO",game_opening.moves.eco,"Opening",game_opening.moves.name,"Position",game_opening.fen.eco+": "+game_opening.fen.name);$.ajax({url:"http://localhost/chesscomutils/write.php",type:"post",data:{pgn:game.pgn()}})}},toggle_pgn_capture:function(){if($("#ccutils_capture").hasClass("saving")){$("#ccutils_capture").html("Capture PGN: Off").removeClass("saving").css("color","white");cometd.unsubscribe(CC.service_game_channel)}else{$("#ccutils_capture").html("Capture PGN: On").addClass("saving").css("color","green");CC.service_game_channel=cometd.subscribe("/service/game",CC.listen)}}};if($("#ccutils_wrapper").length){$("#ccutils_opening").off();$("#ccutils_wrapper").remove();$("#ccutils_capture").off().parent().remove()}else{$("#main_bc").css("margin-top","25px")}window.CC.opening_checker=setInterval(CC.get_opening,5e3);var div_wrapper=$("<div/>").attr("id","ccutils_wrapper").css({position:"fixed",top:35,"z-index":9,color:"white",height:"28px",width:"100%"}).appendTo(body);var div_opening=$("<div/>").attr("id","ccutils_opening").css({"background-color":"#6a943f",margin:"0px 5px",height:"100%","border-radius":"5px 5px 0px 0px","border-top":"1px solid #799e52","border-bottom":"1px solid #4c7637","padding-left":"5px"}).appendTo(div_wrapper).click(window.CC.get_opening);var div_opening_moves=$("<p/>").attr("id","ccutils_opening_moves").css({"font-size":"12px","line-height":"14px"}).appendTo(div_opening);var div_opening_fen=$("<p/>").attr("id","ccutils_opening_fen").css({"font-size":"12px","line-height":"14px"}).appendTo(div_opening);var a_capture=$("<a/>").html("Capture PGN: Off").attr({href:"#",id:"ccutils_capture"}).addClass("bold").click(window.CC.toggle_pgn_capture);$("#top_bar_settings").append($("<li/>").append(a_capture));$("#ccutils_capture").click()})();