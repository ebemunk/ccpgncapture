"use strict";function similar_text(e,t,n){if(null===e||null===t||"undefined"==typeof e||"undefined"==typeof t)return 0;e+="",t+="";var r,o,i,a,c=0,s=0,u=0,l=e.length,f=t.length;for(u=0,r=0;l>r;r++)for(o=0;f>o;o++){for(i=0;l>r+i&&f>o+i&&e.charAt(r+i)===t.charAt(o+i);i++);i>u&&(u=i,c=r,s=o)}return a=u,a&&(c&&s&&(a+=similar_text(e.substr(0,c),t.substr(0,s))),l>c+u&&f>s+u&&(a+=similar_text(e.substr(c+u,l-c-u),t.substr(s+u,f-s-u)))),n?200*a/(l+f):a}var Chess=function(e){function t(){ct=new Array(128),st={w:M,b:M},ut=$,lt={w:0,b:0},ft=M,pt=0,dt=1,ht=[],gt={},c(i())}function n(){r(W)}function r(e){var n=e.split(/\s+/),r=n[0],a=0;if(!o(e).valid)return!1;t();for(var s=0;s<r.length;s++){var l=r.charAt(s);if("/"===l)a+=8;else if(O(l))a+=parseInt(l,10);else{var f="a">l?$:D;u({type:l.toLowerCase(),color:f},I(a)),a++}}return ut=n[1],n[2].indexOf("K")>-1&&(lt.w|=et.KSIDE_CASTLE),n[2].indexOf("Q")>-1&&(lt.w|=et.QSIDE_CASTLE),n[2].indexOf("k")>-1&&(lt.b|=et.KSIDE_CASTLE),n[2].indexOf("q")>-1&&(lt.b|=et.QSIDE_CASTLE),ft="-"===n[3]?M:it[n[3]],pt=parseInt(n[4],10),dt=parseInt(n[5],10),c(i()),!0}function o(e){var t={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."},n=e.split(/\s+/);if(6!==n.length)return{valid:!1,error_number:1,error:t[1]};if(isNaN(n[5])||parseInt(n[5],10)<=0)return{valid:!1,error_number:2,error:t[2]};if(isNaN(n[4])||parseInt(n[4],10)<0)return{valid:!1,error_number:3,error:t[3]};if(!/^(-|[abcdefgh][36])$/.test(n[3]))return{valid:!1,error_number:4,error:t[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(n[2]))return{valid:!1,error_number:5,error:t[5]};if(!/^(w|b)$/.test(n[1]))return{valid:!1,error_number:6,error:t[6]};var r=n[0].split("/");if(8!==r.length)return{valid:!1,error_number:7,error:t[7]};for(var o=0;o<r.length;o++){for(var i=0,a=!1,c=0;c<r[o].length;c++)if(isNaN(r[o][c])){if(!/^[prnbqkPRNBQK]$/.test(r[o][c]))return{valid:!1,error_number:9,error:t[9]};i+=1,a=!1}else{if(a)return{valid:!1,error_number:8,error:t[8]};i+=parseInt(r[o][c],10),a=!0}if(8!==i)return{valid:!1,error_number:10,error:t[10]}}return{valid:!0,error_number:0,error:t[0]}}function i(){for(var e=0,t="",n=it.a8;n<=it.h1;n++){if(null==ct[n])e++;else{e>0&&(t+=e,e=0);var r=ct[n].color,o=ct[n].type;t+=r===$?o.toUpperCase():o.toLowerCase()}n+1&136&&(e>0&&(t+=e),n!==it.h1&&(t+="/"),e=0,n+=8)}var i="";lt[$]&et.KSIDE_CASTLE&&(i+="K"),lt[$]&et.QSIDE_CASTLE&&(i+="Q"),lt[D]&et.KSIDE_CASTLE&&(i+="k"),lt[D]&et.QSIDE_CASTLE&&(i+="q"),i=i||"-";var a=ft===M?"-":I(ft);return[t,ut,i,a,pt,dt].join(" ")}function a(e){for(var t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(gt[e[t]]=e[t+1]);return gt}function c(e){ht.length>0||(e!==W?(gt.SetUp=e,gt.FEN="1"):(delete gt.SetUp,delete gt.FEN))}function s(e){var t=ct[it[e]];return t?{type:t.type,color:t.color}:null}function u(e,t){if(!("type"in e&&"color"in e))return!1;if(-1===z.indexOf(e.type.toLowerCase()))return!1;if(!(t in it))return!1;var n=it[t];return ct[n]={type:e.type,color:e.color},e.type===j&&(st[e.color]=n),c(i()),!0}function l(e){var t=s(e);return ct[it[e]]=null,t&&t.type===j&&(st[t.color]=M),c(i()),t}function f(e,t,n,r,o){var i={color:ut,from:t,to:n,flags:r,piece:e[t].type};return o&&(i.flags|=et.PROMOTION,i.promotion=o),e[n]?i.captured=e[n].type:r&et.EP_CAPTURE&&(i.captured=U),i}function p(e){function t(e,t,n,r,o){if(e[n].type!==U||S(r)!==ot&&S(r)!==tt)t.push(f(e,n,r,o));else for(var i=[Q,B,G,q],a=0,c=i.length;c>a;a++)t.push(f(e,n,r,o,i[a]))}var n=[],r=ut,o=x(r),i={b:rt,w:nt},a=it.a8,c=it.h1,s=!1,u="undefined"!=typeof e&&"legal"in e?e.legal:!0;if("undefined"!=typeof e&&"square"in e){if(!(e.square in it))return[];a=c=it[e.square],s=!0}for(var l=a;c>=l;l++)if(136&l)l+=7;else{var p=ct[l];if(null!=p&&p.color===r)if(p.type===U){var d=l+Y[r][0];if(null==ct[d]){t(ct,n,l,d,et.NORMAL);var d=l+Y[r][1];i[r]===S(l)&&null==ct[d]&&t(ct,n,l,d,et.BIG_PAWN)}for(v=2;4>v;v++){var d=l+Y[r][v];136&d||(null!=ct[d]&&ct[d].color===o?t(ct,n,l,d,et.CAPTURE):d===ft&&t(ct,n,l,ft,et.EP_CAPTURE))}}else for(var v=0,m=F[p.type].length;m>v;v++)for(var b=F[p.type][v],d=l;;){if(d+=b,136&d)break;if(null!=ct[d]){if(ct[d].color===r)break;t(ct,n,l,d,et.CAPTURE);break}if(t(ct,n,l,d,et.NORMAL),"n"===p.type||"k"===p.type)break}}if(!s||c===st[r]){if(lt[r]&et.KSIDE_CASTLE){var C=st[r],y=C+2;null!=ct[C+1]||null!=ct[y]||h(o,st[r])||h(o,C+1)||h(o,y)||t(ct,n,st[r],y,et.KSIDE_CASTLE)}if(lt[r]&et.QSIDE_CASTLE){var C=st[r],y=C-2;null!=ct[C-1]||null!=ct[C-2]||null!=ct[C-3]||h(o,st[r])||h(o,C-1)||h(o,y)||t(ct,n,st[r],y,et.QSIDE_CASTLE)}}if(!u)return n;for(var _=[],l=0,m=n.length;m>l;l++)A(n[l]),g(r)||_.push(n[l]),w();return _}function d(e){var t="";if(e.flags&et.KSIDE_CASTLE)t="O-O";else if(e.flags&et.QSIDE_CASTLE)t="O-O-O";else{var n=k(e);e.piece!==U&&(t+=e.piece.toUpperCase()+n),e.flags&(et.CAPTURE|et.EP_CAPTURE)&&(e.piece===U&&(t+=I(e.from)[0]),t+="x"),t+=I(e.to),e.flags&et.PROMOTION&&(t+="="+e.promotion.toUpperCase())}return A(e),v()&&(t+=m()?"#":"+"),w(),t}function h(e,t){for(var n=it.a8;n<=it.h1;n++)if(136&n)n+=7;else if(null!=ct[n]&&ct[n].color===e){var r=ct[n],o=n-t,i=o+119;if(X[i]&1<<V[r.type]){if(r.type===U){if(o>0){if(r.color===$)return!0}else if(r.color===D)return!0;continue}if("n"===r.type||"k"===r.type)return!0;for(var a=J[i],c=n+a,s=!1;c!==t;){if(null!=ct[c]){s=!0;break}c+=a}if(!s)return!0}}return!1}function g(e){return h(x(e),st[e])}function v(){return g(ut)}function m(){return v()&&0===p().length}function b(){return!v()&&0===p().length}function C(){for(var e={},t=[],n=0,r=0,o=it.a8;o<=it.h1;o++)if(r=(r+1)%2,136&o)o+=7;else{var i=ct[o];i&&(e[i.type]=i.type in e?e[i.type]+1:1,i.type===G&&t.push(r),n++)}if(2===n)return!0;if(3===n&&(1===e[G]||1===e[q]))return!0;if(n===e[G]+2){for(var a=0,c=t.length,o=0;c>o;o++)a+=t[o];if(0===a||a===c)return!0}return!1}function y(){for(var e=[],t={},n=!1;;){var r=w();if(!r)break;e.push(r)}for(;;){var o=i().split(" ").slice(0,4).join(" ");if(t[o]=o in t?t[o]+1:1,t[o]>=3&&(n=!0),!e.length)break;A(e.pop())}return n}function _(){for(var e=[],t={},n=!1;;){var r=w();if(!r)break;e.push(r)}for(;;){var o=i().split(" ").slice(0,4).join(" ");if(t[o]=o in t?t[o]+1:1,t[o]>=2&&(n=!0),!e.length)break;A(e.pop())}return n}function E(e){ht.push({move:e,kings:{b:st.b,w:st.w},turn:ut,castling:{b:lt.b,w:lt.w},ep_square:ft,half_moves:pt,move_number:dt})}function A(e){var t=ut,n=x(t);if(E(e),ct[e.to]=ct[e.from],ct[e.from]=null,e.flags&et.EP_CAPTURE&&(ut===D?ct[e.to-16]=null:ct[e.to+16]=null),e.flags&et.PROMOTION&&(ct[e.to]={type:e.promotion,color:t}),ct[e.to].type===j){if(st[ct[e.to].color]=e.to,e.flags&et.KSIDE_CASTLE){var r=e.to-1,o=e.to+1;ct[r]=ct[o],ct[o]=null}else if(e.flags&et.QSIDE_CASTLE){var r=e.to+1,o=e.to-2;ct[r]=ct[o],ct[o]=null}lt[t]=""}if(lt[t])for(var i=0,a=at[t].length;a>i;i++)if(e.from===at[t][i].square&&lt[t]&at[t][i].flag){lt[t]^=at[t][i].flag;break}if(lt[n])for(var i=0,a=at[n].length;a>i;i++)if(e.to===at[n][i].square&&lt[n]&at[n][i].flag){lt[n]^=at[n][i].flag;break}ft=e.flags&et.BIG_PAWN?"b"===ut?e.to-16:e.to+16:M,e.piece===U?pt=0:e.flags&(et.CAPTURE|et.EP_CAPTURE)?pt=0:pt++,ut===D&&dt++,ut=x(ut)}function w(){var e=ht.pop();if(null==e)return null;var t=e.move;st=e.kings,ut=e.turn,lt=e.castling,ft=e.ep_square,pt=e.half_moves,dt=e.move_number;var n=ut,r=x(ut);if(ct[t.from]=ct[t.to],ct[t.from].type=t.piece,ct[t.to]=null,t.flags&et.CAPTURE)ct[t.to]={type:t.captured,color:r};else if(t.flags&et.EP_CAPTURE){var o;o=n===D?t.to-16:t.to+16,ct[o]={type:U,color:r}}if(t.flags&(et.KSIDE_CASTLE|et.QSIDE_CASTLE)){var i,a;t.flags&et.KSIDE_CASTLE?(i=t.to+1,a=t.to-1):t.flags&et.QSIDE_CASTLE&&(i=t.to-2,a=t.to+1),ct[i]=ct[a],ct[a]=null}return t}function k(e){for(var t=p(),n=e.from,r=e.to,o=e.piece,i=0,a=0,c=0,s=0,u=t.length;u>s;s++){var l=t[s].from,f=t[s].to,d=t[s].piece;o===d&&n!==l&&r===f&&(i++,S(n)===S(l)&&a++,P(n)===P(l)&&c++)}return i>0?a>0&&c>0?I(n):I(n).charAt(c>0?1:0):""}function T(){for(var e="   +------------------------+\n",t=it.a8;t<=it.h1;t++){if(0===P(t)&&(e+=" "+"87654321"[S(t)]+" |"),null==ct[t])e+=" . ";else{var n=ct[t].type,r=ct[t].color,o=r===$?n.toUpperCase():n.toLowerCase();e+=" "+o+" "}t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}function S(e){return e>>4}function P(e){return 15&e}function I(e){var t=P(e),n=S(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function x(e){return e===$?D:$}function O(e){return-1!=="0123456789".indexOf(e)}function K(e){var t=L(e);t.san=d(t),t.to=I(t.to),t.from=I(t.from);var n="";for(var r in et)et[r]&t.flags&&(n+=Z[r]);return t.flags=n,t}function L(e){var t=e instanceof Array?[]:{};for(var n in e)t[n]="object"==typeof n?L(e[n]):e[n];return t}function N(e){return e.replace(/^\s+|\s+$/g,"")}function R(e){for(var t=p({legal:!1}),n=0,r=ut,o=0,i=t.length;i>o;o++){if(A(t[o]),!g(r))if(e-1>0){var a=R(e-1);n+=a}else n++;w()}return n}var D="b",$="w",M=-1,U="p",q="n",G="b",B="r",Q="q",j="k",z="pnbrqkPNBRQK",W="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",H=["1-0","0-1","1/2-1/2","*"],Y={b:[16,32,17,15],w:[-16,-32,-17,-15]},F={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},X=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],J=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],V={p:0,n:1,b:2,r:3,q:4,k:5},Z={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},et={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},tt=7,nt=6,rt=1,ot=0,it={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},at={w:[{square:it.a1,flag:et.QSIDE_CASTLE},{square:it.h1,flag:et.KSIDE_CASTLE}],b:[{square:it.a8,flag:et.QSIDE_CASTLE},{square:it.h8,flag:et.KSIDE_CASTLE}]},ct=new Array(128),st={w:M,b:M},ut=$,lt={w:0,b:0},ft=M,pt=0,dt=1,ht=[],gt={};return r("undefined"==typeof e?W:e),{WHITE:$,BLACK:D,PAWN:U,KNIGHT:q,BISHOP:G,ROOK:B,QUEEN:Q,KING:j,SQUARES:function(){for(var e=[],t=it.a8;t<=it.h1;t++)136&t?t+=7:e.push(I(t));return e}(),FLAGS:Z,load:function(e){return r(e)},reset:function(){return n()},moves:function(e){for(var t=p(e),n=[],r=0,o=t.length;o>r;r++)n.push("undefined"!=typeof e&&"verbose"in e&&e.verbose?K(t[r]):d(t[r]));return n},in_check:function(){return v()},in_checkmate:function(){return m()},in_stalemate:function(){return b()},in_draw:function(){return pt>=100||b()||C()||y()},insufficient_material:function(){return C()},in_threefold_repetition:function(){return y()},in_twofold_repetition:function(){return _()},game_over:function(){return pt>=100||m()||b()||C()||y()},validate_fen:function(e){return o(e)},fen:function(){return i()},pgn:function(e){var t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",n="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,r=[],o=!1;for(var i in gt)r.push("["+i+' "'+gt[i]+'"]'+t),o=!0;o&&ht.length&&r.push(t);for(var a=[];ht.length>0;)a.push(w());for(var c=[],s="",u=1;a.length>0;){var l=a.pop();1===u&&"b"===l.color?(s="1. ...",u++):"w"===l.color&&(s.length&&c.push(s),s=u+".",u++),s=s+" "+d(l),A(l)}if(s.length&&c.push(s),"undefined"!=typeof gt.Result&&c.push(gt.Result),0===n)return r.join("")+c.join(" ");for(var f=0,i=0;i<c.length;i++)f+c[i].length>n&&0!==i?(" "===r[r.length-1]&&r.pop(),r.push(t),f=0):0!==i&&(r.push(" "),f++),r.push(c[i]),f+=c[i].length;return r.join("")},load_pgn:function(e,t){function r(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function o(e){var t,n,r,o=et.NORMAL,i=e.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=?[NBRQ])?/);if("O-O-O"===e.slice(0,5))n=st[ut],t=n-2,o=et.QSIDE_CASTLE;else if("O-O"===e.slice(0,3))n=st[ut],t=n+2,o=et.KSIDE_CASTLE;else if(i&&i[1]){var a=i[1].toLowerCase();i[3]&&(o=et.CAPTURE),t=it[i[4]];for(var c=0,s=F[a].length;s>c;c++)for(var u=F[a][c],l=t;;){if(l+=u,136&l)break;var p=ct[l];if(p){p.color===ut&&p.type===a&&(!i[2]||I(l).indexOf(i[2])>=0)&&(n=l);break}if("n"===a||"k"===a)break}}else if(i){if(i[3]){t=it[i[4]];for(var c=2;4>c;c++){var l=t-Y[ut][c];136&l||null!=ct[l]&&ct[l].color===ut&&I(l)[0]===i[2]&&(n=l)}o=ct[t]?et.CAPTURE:et.EP_CAPTURE}else{t=it[e.slice(0,2)];var d=t-Y[ut][0],p=ct[d];p&&p.type===U&&p.color===ut?n=d:(d=t-Y[ut][1],p=ct[d],p&&p.type===U&&p.color===ut&&(n=d,o=et.BIG_PAWN))}i[5]&&(r="undefined"==typeof i[5][1]?i[5][0].toLowerCase():i[5][1].toLowerCase())}return n>=0&&t>=0&&o?f(ct,n,t,o,r):void(e.length>0)}function i(e){return o(N(e))}function c(e){var t=!1;for(var n in e)t=!0;return t}function s(e,t){for(var n="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",r={},o=e.split(n),i="",a="",c=0;c<o.length;c++)i=o[c].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),a=o[c].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),N(i).length>0&&(r[i]=a);return r}var u="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",l=new RegExp("^(\\[(.|"+r(u)+")*\\])("+r(u)+")*1.("+r(u)+"|.)*$","g"),p=e.replace(l,"$1");"["!==p[0]&&(p=""),n();var d=s(p,t);for(var h in d)a([h,d[h]]);var g=e.replace(p,"").replace(new RegExp(r(u),"g")," ");g=g.replace(/(\{[^}]+\})+?/g,""),g=g.replace(/\d+\./g,"");var v=N(g).split(new RegExp(/\s+/));v=v.join(",").replace(/,,+/g,",").split(",");for(var m="",b=0;b<v.length-1;b++){if(m=i(v[b]),null==m)return!1;A(m)}if(m=v[v.length-1],H.indexOf(m)>-1)c(gt)&&"undefined"==typeof gt.Result&&a(["Result",m]);else{if(m=i(m),null==m)return!1;A(m)}return!0},header:function(){return a(arguments)},ascii:function(){return T()},turn:function(){return ut},move:function(e){var t=null,n=p();if("string"==typeof e){for(var r=0,o=n.length;o>r;r++)if(e===d(n[r])){t=n[r];break}}else if("object"==typeof e)for(var r=0,o=n.length;o>r;r++)if(!(e.from!==I(n[r].from)||e.to!==I(n[r].to)||"promotion"in n[r]&&e.promotion!==n[r].promotion)){t=n[r];break}if(!t)return null;var i=K(t);return A(t),i},undo:function(){var e=w();return e?K(e):null},clear:function(){return t()},put:function(e,t){return u(e,t)},get:function(e){return s(e)},remove:function(e){return l(e)},perft:function(e){return R(e)},square_color:function(e){if(e in it){var t=it[e];return(S(t)+P(t))%2===0?"light":"dark"}return null},history:function(e){for(var t=[],n=[],r=("undefined"!=typeof e&&"verbose"in e&&e.verbose);ht.length>0;)t.push(w());for(;t.length>0;){var o=t.pop();n.push(r?K(o):d(o)),A(o)}return n}}};"undefined"!=typeof exports&&(exports.Chess=Chess),function(e,t){function n(t){var n,r=e(t.ownerDocument);return t=e(t),n=t.offset(),{x:n.left+t.outerWidth()/2-r.scrollLeft(),y:n.top+t.outerHeight()/2-r.scrollTop()}}var r=/^key/,o=/^(?:mouse|contextmenu)|click/;e.fn.simulate=function(t,n){return this.each(function(){new e.simulate(this,t,n)})},e.simulate=function(t,n,r){var o=e.camelCase("simulate-"+n);this.target=t,this.options=r,this[o]?this[o]():this.simulateEvent(t,n,r)},e.extend(e.simulate,{keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},buttonCode:{LEFT:0,MIDDLE:1,RIGHT:2}}),e.extend(e.simulate.prototype,{simulateEvent:function(e,t,n){var r=this.createEvent(t,n);this.dispatchEvent(e,t,r,n)},createEvent:function(e,t){return r.test(e)?this.keyEvent(e,t):o.test(e)?this.mouseEvent(e,t):void 0},mouseEvent:function(n,r){var o,i,a,c;return r=e.extend({bubbles:!0,cancelable:"mousemove"!==n,view:window,detail:0,screenX:0,screenY:0,clientX:1,clientY:1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:t},r),document.createEvent?(o=document.createEvent("MouseEvents"),o.initMouseEvent(n,r.bubbles,r.cancelable,r.view,r.detail,r.screenX,r.screenY,r.clientX,r.clientY,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.button,r.relatedTarget||document.body.parentNode),0===o.pageX&&0===o.pageY&&Object.defineProperty&&(i=o.relatedTarget.ownerDocument||document,a=i.documentElement,c=i.body,Object.defineProperty(o,"pageX",{get:function(){return r.clientX+(a&&a.scrollLeft||c&&c.scrollLeft||0)-(a&&a.clientLeft||c&&c.clientLeft||0)}}),Object.defineProperty(o,"pageY",{get:function(){return r.clientY+(a&&a.scrollTop||c&&c.scrollTop||0)-(a&&a.clientTop||c&&c.clientTop||0)}}))):document.createEventObject&&(o=document.createEventObject(),e.extend(o,r),o.button={0:1,1:4,2:2}[o.button]||o.button),o},keyEvent:function(n,r){var o;if(r=e.extend({bubbles:!0,cancelable:!0,view:window,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:0,charCode:t},r),document.createEvent)try{o=document.createEvent("KeyEvents"),o.initKeyEvent(n,r.bubbles,r.cancelable,r.view,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.keyCode,r.charCode)}catch(i){o=document.createEvent("Events"),o.initEvent(n,r.bubbles,r.cancelable),e.extend(o,{view:r.view,ctrlKey:r.ctrlKey,altKey:r.altKey,shiftKey:r.shiftKey,metaKey:r.metaKey,keyCode:r.keyCode,charCode:r.charCode})}else document.createEventObject&&(o=document.createEventObject(),e.extend(o,r));return(/msie [\w.]+/.exec(navigator.userAgent.toLowerCase())||"[object Opera]"==={}.toString.call(window.opera))&&(o.keyCode=r.charCode>0?r.charCode:r.keyCode,o.charCode=t),o},dispatchEvent:function(e,t,n){e.dispatchEvent?e.dispatchEvent(n):e.fireEvent&&e.fireEvent("on"+t,n)},simulateFocus:function(){function t(){r=!0}var n,r=!1,o=e(this.target);o.bind("focus",t),o[0].focus(),r||(n=e.Event("focusin"),n.preventDefault(),o.trigger(n),o.triggerHandler("focus")),o.unbind("focus",t)},simulateBlur:function(){function t(){r=!0}var n,r=!1,o=e(this.target);o.bind("blur",t),o[0].blur(),setTimeout(function(){o[0].ownerDocument.activeElement===o[0]&&o[0].ownerDocument.body.focus(),r||(n=e.Event("focusout"),n.preventDefault(),o.trigger(n),o.triggerHandler("blur")),o.unbind("blur",t)},1)}}),e.extend(e.simulate.prototype,{simulateDrag:function(){var e=0,t=this.target,r=this.options,o=n(t),i=Math.floor(o.x),a=Math.floor(o.y),c=r.dx||0,s=r.dy||0,u=r.moves||3,l={clientX:i,clientY:a};for(this.simulateEvent(t,"mousedown",l);u>e;e++)i+=c/u,a+=s/u,l={clientX:Math.round(i),clientY:Math.round(a)},this.simulateEvent(document,"mousemove",l);this.simulateEvent(t,"mouseup",l),this.simulateEvent(t,"click",l)}})}(jQuery),function(e,t){function n(e,t,n){return e.addEventListener?void e.addEventListener(t,n,!1):void e.attachEvent("on"+t,n)}function r(e){if("keypress"==e.type){var t=String.fromCharCode(e.which);return e.shiftKey||(t=t.toLowerCase()),t}return E[e.which]?E[e.which]:A[e.which]?A[e.which]:String.fromCharCode(e.which).toLowerCase()}function o(e,t){return e.sort().join(",")===t.sort().join(",")}function i(e){e=e||{};var t,n=!1;for(t in P)e[t]?n=!0:P[t]=0;n||(O=!1)}function a(e,t,n,r,i,a){var c,s,u=[],l=n.type;if(!T[e])return[];for("keyup"==l&&f(e)&&(t=[e]),c=0;c<T[e].length;++c)if(s=T[e][c],(r||!s.seq||P[s.seq]==s.level)&&l==s.action&&("keypress"==l&&!n.metaKey&&!n.ctrlKey||o(t,s.modifiers))){var p=!r&&s.combo==i,d=r&&s.seq==r&&s.level==a;(p||d)&&T[e].splice(c,1),u.push(s)}return u}function c(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}function s(e,t,n,r){L.stopCallback(t,t.target||t.srcElement,n,r)||e(t,n)===!1&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.returnValue=!1,t.cancelBubble=!0)}function u(e,t,n){var r,o=a(e,t,n),c={},u=0,l=!1;for(r=0;r<o.length;++r)o[r].seq&&(u=Math.max(u,o[r].level));for(r=0;r<o.length;++r)if(o[r].seq){if(o[r].level!=u)continue;l=!0,c[o[r].seq]=1,s(o[r].callback,n,o[r].combo,o[r].seq)}else l||s(o[r].callback,n,o[r].combo);var p="keypress"==n.type&&x;n.type!=O||f(e)||p||i(c),x=l&&"keydown"==n.type}function l(e){"number"!=typeof e.which&&(e.which=e.keyCode);var t=r(e);if(t)return"keyup"==e.type&&I===t?void(I=!1):void L.handleKey(t,c(e),e)}function f(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function p(){clearTimeout(_),_=setTimeout(i,1e3)}function d(){if(!y){y={};for(var e in E)e>95&&112>e||E.hasOwnProperty(e)&&(y[E[e]]=e)}return y}function h(e,t,n){return n||(n=d()[e]?"keydown":"keypress"),"keypress"==n&&t.length&&(n="keydown"),n}function g(e,t,n,o){function a(t){return function(){O=t,++P[e],p()}}function c(t){s(n,t,e),"keyup"!==o&&(I=r(t)),setTimeout(i,10)}P[e]=0;for(var u=0;u<t.length;++u){var l=u+1===t.length,f=l?c:a(o||m(t[u+1]).action);b(t[u],f,o,e,u)}}function v(e){return"+"===e?["+"]:e.split("+")}function m(e,t){var n,r,o,i=[];for(n=v(e),o=0;o<n.length;++o)r=n[o],k[r]&&(r=k[r]),t&&"keypress"!=t&&w[r]&&(r=w[r],i.push("shift")),f(r)&&i.push(r);return t=h(r,i,t),{key:r,modifiers:i,action:t}}function b(e,t,n,r,o){S[e+":"+n]=t,e=e.replace(/\s+/g," ");var i,c=e.split(" ");return c.length>1?void g(e,c,t,n):(i=m(e,n),T[i.key]=T[i.key]||[],a(i.key,i.modifiers,{type:i.action},r,e,o),void T[i.key][r?"unshift":"push"]({callback:t,modifiers:i.modifiers,action:i.action,seq:r,level:o,combo:e}))}function C(e,t,n){for(var r=0;r<e.length;++r)b(e[r],t,n)}for(var y,_,E={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},A={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},w={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},k={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},T={},S={},P={},I=!1,x=!1,O=!1,K=1;20>K;++K)E[111+K]="f"+K;for(K=0;9>=K;++K)E[K+96]=K;n(t,"keypress",l),n(t,"keydown",l),n(t,"keyup",l);var L={bind:function(e,t,n){return e=e instanceof Array?e:[e],C(e,t,n),this},unbind:function(e,t){return L.bind(e,function(){},t)},trigger:function(e,t){return S[e+":"+t]&&S[e+":"+t]({},e),this},reset:function(){return T={},S={},this},stopCallback:function(e,t){return(" "+t.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==t.tagName||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.isContentEditable},handleKey:u};e.Mousetrap=L,"function"==typeof define&&define.amd&&define(L)}(window,document),function(){$.extend(CC,{classify_opening:function(e){var t,n,r=new Chess,o="";return $.each(e,function(e,i){0===e?o+="1.":e%2===0&&(o+=e/2+1+"."),o+=i+" ",r.move(i);var a=CC.openings[o.trim()];a&&(t=a);var c=CC.openings[CC.openings_fen[r.fen()]];c&&(n=c)}),{moves:t,fen:n}},get_opening:function(e){var t=$('div[id^="notation_"]:visible');if(!t.length)return $("#ccutils_opening_moves").text("Notation window not visible."),void $("#ccutils_opening_fen").text("");if(t.length>1)return $("#ccutils_opening_moves").text("Cannot run when games popped-out."),void $("#ccutils_opening_fen").text(":(");var n=window.location.hash.replace(/#(g|a)=/,"");if(CC.analyzed_games_cache[n]&&CC.analyzed_games_cache[n].count>4&&"N/A"!=CC.analyzed_games_cache[n].opening&&CC.analyzed_games_cache[n].num_moves>16&&!e)return $("#ccutils_opening_moves").text(CC.analyzed_games_cache[n].opening),void $("#ccutils_opening_fen").text(CC.analyzed_games_cache[n].fen);var r,o=[];r=t.find(".notationVertical"),r.length?r.each(function(e,t){$(t).find(".gotomove").each(function(e,t){o.push($(t).text())})}):(r=t.find(".notationHorizontal"),r.length&&r.each(function(e,t){$(t).find(".gotomove").each(function(e,t){var n=$(t).text().match(/\d*\.\s*(.*)/);o.push(n?n[1]:$(t).text())})}));var i,a,c=CC.classify_opening(o);i=c.moves?"Opening: "+c.moves.eco+":  "+c.moves.name+" ("+c.moves.moves+")":"N/A",a=c.fen?"Position: "+c.fen.eco+":  "+c.fen.name+" ("+c.fen.moves+")":"N/A";var s=1;return CC.analyzed_games_cache[n]&&CC.analyzed_games_cache[n].opening==i&&CC.analyzed_games_cache[n].fen==a&&(s=CC.analyzed_games_cache[n].count+1),CC.analyzed_games_cache[n]={opening:i,fen:a,count:s,num_moves:o.length},$("#ccutils_opening_moves").text()!=i&&$("#ccutils_opening_moves").text(i),$("#ccutils_opening_fen").text()!=a&&$("#ccutils_opening_fen").text(a),c},opening_refresh:function(){CC.game_all_channel=$.cometd.addListener("/game/*",function(e){CC.get_opening(e)})},flash_keyboard_icon:function(){$("#ccutils_keyboard_icon").animate({opacity:1},100).animate({opacity:.3},100)},announce_opening:function(){var e=CC.get_opening(!0);if(e){var t;t=e.moves.eco==e.fen.eco?"Opening: ("+e.moves.eco+") "+e.moves.name+" ("+(e.moves.moves.match(/\s/g).length+1)+"-ply)":similar_text(e.moves.name,e.fen.name,!0)>50?"Position: ("+e.fen.eco+") "+e.fen.name+" ("+(e.fen.moves.match(/\s/g).length+1)+"-ply)":"Position: ("+e.fen.eco+") "+e.fen.name+" ("+(e.fen.moves.match(/\s/g).length+1)+"-ply), transposed from Opening: ("+e.moves.eco+") "+e.moves.name,$(".chatInputGameWrapper input[id^=chatInput_]:visible").first().val(t),$(".chatInputGameWrapper button[id^=chatInputButton_]").click(),CC.flash_keyboard_icon(),CC.last_chat=Math.round((new Date).getTime()/1e3)+5}}}),CC.opening_checker=setInterval(CC.get_opening,5e3),CC.analyzed_games_cache={},setInterval(function(){CC.analyzed_games_cache={}},3e5),CC.opening_refresh();var e=$("<div/>").attr("id","ccutils_wrapper").css({position:"fixed",top:35,"z-index":9,color:"white",height:"28px",width:"100%"}).appendTo(body),t=$("<div/>").attr("id","ccutils_opening").css({"background-color":"#6a943f",margin:"0px 5px",height:"100%","border-radius":"5px 5px 0px 0px","border-top":"1px solid #799e52","border-bottom":"1px solid #4c7637","padding-left":"5px"}).appendTo(e).click(CC.get_opening),n=($("<p/>").attr({id:"ccutils_opening_moves",title:"Opening classification according to the move order."}).css({"font-size":"12px","line-height":"14px"}).appendTo(t),$("<p/>").attr({id:"ccutils_opening_fen",title:"Opening classification according to the game position."}).css({"font-size":"12px","line-height":"14px"}).appendTo(t),$("<div/>").attr("id","ccutils_keyboard_icon").css({"background-image":"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACEUlEQVRYhe3WMUhVURgH8N8xEZGIBgmRiKjFJFpqiIoWy6GhNVocm4qWkJpEJGoLXJormhtU2iKCBhscKiJaopJKCbEQCTFPw/2eXV/vYQ96vOV9l8O9/+/7zjn/+53/PeemLGuldbR09jaBNoE2AXRWHpJ0CuM40MT51nAPk1legVTZiJL0GMN400QCe9CDoSy/oFQB7MUKTuJnkwhMYBS7K45aGliP1oGNLK+V8HpgkOW1wOXcjarc6tgWqyfCM/iCa4EvYwHnk9SLKcwmqTdJxyM2kaQO3Im+A5G7gIf1StJZx7+MOXwO/DXwkkJI77AYlVmJ2IfIfR94NcbfhZ31CMhx4RW+oydwR6WVcrbFVbF+ZMyE71bg4UpezQokaRBXSngmy9MYwaEk3cUP3MAnTCbpNC4k6UFU4DoO1n3zsHpLsB+X/NHIEqZxVqGPRwpBjeA1JnEk+syG7yIGov96owSeVLFfjvtVdCvWfwNHS4PfD5LfFOs/hK6IrTZKoBt9mM/yfJL6knSiFN9XTk5SeffsD3IvFYI9pqjgYs2ZaokQ5xRiGY/YaOBG2mHFzpcx1ZAIFZ/ZGJ4GfhZ4O9uBX1GBRcUnOoa39TrUItCFj7gNSepSqHruHwjUsvI4f81XdsxjEM/V2DL/k/UpqlIR9RYCNxVv38zjeElxHG+euJvHcaus5X9EbQJtAm0CvwEi8Mhr8HnPPAAAAABJRU5ErkJggg==')",position:"fixed",top:34,right:10,"z-index":9,height:32,width:32,opacity:.3}).attr("title",' Key Bindings:\n   "shift+c s" Seek Game\n   "shift+c d" Offer Draw\n   "shift+c r" Resign\n   "shift+c shift+r" Clean Refresh\n   "shift+c shift+a" Announce Opening').appendTo(body),setInterval(function(){Mousetrap&&(clearInterval(n),Mousetrap.bind("shift+c s",function(){CC.flash_keyboard_icon(),$("#new_game_pane_create_button").click()}),Mousetrap.bind("shift+c d",function(){$("input[id^=b-draw]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-draw]:visible").click())}),Mousetrap.bind("shift+c r",function(){$("input[id^=b-resign-abort]:visible").get(0)&&(CC.flash_keyboard_icon(),$("input[id^=b-resign-abort]:visible").click())}),Mousetrap.bind("shift+c shift+r",function(){CC.flash_keyboard_icon(),$(".nowrapTabStrip .dijitTabCloseButton").click(),setTimeout(function(){window.location="http://live.chess.com/live"},350)}),Mousetrap.bind("shift+c shift+a",function(){CC.announce_opening()}))},300))}(),function(){$.extend(CC,{decode:{a:"a1",i:"a2",q:"a3",y:"a4",G:"a5",O:"a6",W:"a7",4:"a8",b:"b1",j:"b2",r:"b3",z:"b4",H:"b5",P:"b6",X:"b7",5:"b8",c:"c1",k:"c2",s:"c3",A:"c4",I:"c5",Q:"c6",Y:"c7",6:"c8",d:"d1",l:"d2",t:"d3",B:"d4",J:"d5",R:"d6",Z:"d7",7:"d8",e:"e1",m:"e2",u:"e3",C:"e4",K:"e5",S:"e6",0:"e7",8:"e8",f:"f1",n:"f2",v:"f3",D:"f4",L:"f5",T:"f6",1:"f7",9:"f8",g:"g1",o:"g2",w:"g3",E:"g4",M:"g5",U:"g6",2:"g7","!":"g8",h:"h1",p:"h2",x:"h3",F:"h4",N:"h5",V:"h6",3:"h7","?":"h8"},promotions:{"{":[-1,"q"],"~":[0,"q"],"}":[1,"q"],"(":[-1,"n"],"^":[0,"n"],")":[1,"n"],"[":[-1,"r"],_:[0,"r"],"]":[1,"r"],"@":[-1,"b"],"#":[0,"b"],$:[1,"b"]},decode_moves:function(e){for(var t=new Chess,n=!0,r=0;r<e.length-1;r+=2){var o=e[r];o=CC.decode[o];var i=e[r+1],a="",c=n?1:-1;if(i in CC.promotions){a=CC.promotions[i][1];var s=String.fromCharCode(o.charCodeAt(0)+CC.promotions[i][0]),u=String.fromCharCode(o.charCodeAt(1)+c);i=s+u}else i=CC.decode[i];t.move({from:o,to:i,promotion:a}),n=!n}return t},listen:function(e,t){if("finished"==e.data.game.status){var n,r=CC.decode_moves(e.data.game.moves),o=CC.classify_opening(r.history()),i=new Date,a=i.getMonth()+1,c=i.getDate(),s=i.getFullYear()+"."+((""+a).length<2?"0":"")+a+"."+((""+c).length<2?"0":"")+c,u=!1,l=!1;"win"==e.data.game.results[0]?(n="1-0",l=0,u=1):"win"==e.data.game.results[1]?(n="0-1",l=1,u=0):n="1/2-1/2";var f;switch(e.data.game.results[u]){case"resigned":f=e.data.game.players[l].uid+" won by resignation.";break;case"timeout":f=e.data.game.players[l].uid+" won on time.";break;case"checkmated":f=e.data.game.players[l].uid+" won by checkmate.";break;case"abandoned":f=e.data.game.players[l].uid+" won - game abandoned.";break;case"agreed":f="Game drawn by agreement.";break;case"stalemate":f="Game drawn by stalemate.";break;case"repetition":f="Game drawn by repetition.";break;case"insufficient":f="Game drawn - insufficient material."}r.header("Event","Live Chess","Site","Chess.com","Date",s,"White",e.data.game.players[0].uid,"Black",e.data.game.players[1].uid,"Result",n,"WhiteElo",e.data.ratings[0],"BlackElo",e.data.ratings[1],"Termination",f,"ECO",o.moves.eco,"Opening",o.moves.name,"Position",o.fen.eco+": "+o.fen.name),$.ajax({url:"http://localhost/chesscomutils/write.php",type:"post",data:{pgn:r.pgn(),filename:t}}),console.log("WRITER REQUEST",t)}},toggle_pgn_capture:function(){$("#ccutils_capture").hasClass("saving")?($("#ccutils_capture").html("Capture PGN: Off").removeClass("saving").css("color","white"),$.cometd.unsubscribe(CC.service_game_channel)):($("#ccutils_capture").html("Capture PGN: On").addClass("saving").css("color","green"),CC.service_game_channel=$.cometd.subscribe("/service/game",CC.listen))
}});var e=$("<a/>").html("Capture PGN: Off").attr({href:"#",id:"ccutils_capture",title:"Capture all finished games in the PGN file."}).addClass("bold").click(CC.toggle_pgn_capture);$("#top_bar_settings").append($("<li/>").append(e)),$("#ccutils_capture").click()}();